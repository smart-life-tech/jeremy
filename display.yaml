# 43inch-display.yaml — AUTO FIX v41_PROPER_SETTINGS — 2026-01-12
# ============================================================================
# Waveshare ESP32-S3-LCD-4.3" Air Quality Monitor - VERSION 41
# ============================================================================
# VERSION HISTORY:
# v39 (2026-01-15) - OPTION 1: REMOVED display.enable_pin so CH422G pin 2 can be
#                  - dedicated to backlight control (no pin sharing).
# v38 (2026-01-12) - ADDED PROPER BACKLIGHT CONTROL
#                  - Added CH422G backlight PWM control (proper hardware pin)
#                  - Restored backlight on/off functionality
#                  - Screen off now actually turns off backlight
#
# v37 (2026-01-12) - FIXED SCREEN SAVER BUGS
#                  - Fixed: Removed non-existent backlight control
#                  - Fixed: Corrected lambda syntax errors
#                  - Screen off shows black page instead
#
# v36 (2026-01-12) - ADDED SCREEN SAVER & SCREEN OFF TIMER
#                  - Screen saver: "TotalSense by Jeremy Boven" moving text
#                  - Text moves around perimeter, contained within display bounds
#                  - Screen saver timer: 1-30 minutes (configurable in Settings via HA)
#                  - Screen off timer: 5-60 minutes (configurable in Settings via HA)
#                  - Touch anywhere to wake from screen saver or screen off
#                  - Settings page: Added display timer information
#                  - Automatic activity tracking resets timers on any touch
#
# v27 (2026-01-11) - PROFESSIONAL SAFETY DASHBOARD - SENSORS PAGE ONLY
# v29 (2026-01-11) - FIXED BAR SCALES + HEAVIER FILTERING
# v35 (2026-01-12 12:20) - CO2 SCALING + RAW GAS VOLTAGES ON DISPLAY
#                  - CO2 arc max: 4000 -> 6000 ppm (2400 ppm = 40% not 60%)
#                  - Added RAW gas voltages to sensors page (CO/NH3/NO2 in mV)
#                  - BME680 IAQ: Added cold weather warning (<50°F IAQ unreliable)
#                  - Fixed IAQ color matching legend exactly
#                  - Scrollbars still OFF (were already removed in v31)
#
# v34 (2026-01-12 12:10) - FIXED TEMP OFFSET APPLICATION
#                  - REMOVED exponential filter from SCD41 temp (was preventing offset on boot)
#                  - Increased SCD41 offset max: -15 -> -40°F (for hot case scenarios)
#                  - Increased BME680 offset max: -20 -> -40°F (consistency)
#                  - Offsets now apply IMMEDIATELY on boot (no gradual ramp)
#                  - User can compensate for full 20°F+ sensor self-heating
#
# v33 (2026-01-12 11:55) - ADAPTIVE METERS + TEMP OFFSET SLIDERS
#                  - Added BME680 temp offset slider (adjustable in HA)
#                  - Added SCD41 temp offset slider (default -8°F, gradual ramp)
#                  - Fixed CO2 meter: 2000 -> 4000 ppm range (adaptive scale)
#                  - Fixed IAQ legend: corrected thresholds (150/300/400 not 50/100/200)
#                  - SCD41 temp uses exponential averaging (gradual warmup, no cold shock)
#
# v32 (2026-01-12 11:40) - CRITICAL FIXES
#                  - Fixed YAML error: scrollbar_mode: "OFF" -> "OFF" (quoted)
#                  - Added BME680 temperature offset: -10°F
#                  - Added CO2 alert ratio threshold (like MiCS sensors)
#                  - Fixed battery charging detection (less sensitive)
#
# v31 (2026-01-11 21:05) - REMOVED SCROLLBARS + OPTIMIZED LVGL RENDERING
#                  - Disabled scrollbars on all pages (scroll_snap_x: true, scrollbar_mode: off)
#                  - Reduced initial LVGL update complexity to prevent 287ms warning
#                  - SCD4x I2C NACK on startup is hardware initialization (normal, self-clears)
#
# v30 (2026-01-11 20:50) - RELAXED COLOR THRESHOLDS + REMOVED MISSING SYMBOLS
#                  - Fixed missing font glyphs: ! -> !, kOhm -> kOhm
#                  - CO2 colors: Green <1200, Yellow 1200-1800, Orange 1800-2500, Red >2500
#                  - IAQ colors: Green <150, Yellow 150-300, Orange 300-400, Red >400
#                  - VOC colors: Green <5, Yellow 5-10, Red >10
#                  - Result: User readings (1844 CO2, 382 IAQ, 7.6 VOC) show as yellow/orange
#
#                  - NO2 bar: 5 -> 50 max (fixes 0.9 ppm pegging issue)
#                  - CO bar: 200 -> 500 max (more headroom)
#                  - NH3 bar: 100 -> 200 max (more headroom)
#                  - All gas sensors: Added median filter + doubled moving average (20 samples)
#                  - Result: Much smoother, slower-responding readings
#
#                  - FIXED: BME680 data now displayed (was missing in v26!)
#                  - Enhanced sensors page with 6-card layout
#                  - Dynamic color-coded safety indicators
#                  - Real-time danger warnings
#                  - ALL OTHER PAGES UNCHANGED FROM v26_fixed2
#
# v26_fixed2 (2026-01-10) - Added BME680 sensor integration
#
# v26 (2026-01-10) - FIXED: LVGL widget schema for ESPHome 2025.12.5 (image/arc/bar indicator options)
#                  - FIXED: References to missing id air_quality_index -> garage_iaq
#                  - No features removed; only syntax fixes so it compiles
#
# v25 (2025-01-11) - ADDED: BME680 sensor @ 0x77 (VOC detection + IAQ scoring)
#                  - Professional sensor grouping in Home Assistant
#                  - Local BME680 named "Display BME680" to distinguish from HA remotes
#                  - All BME680 metrics: IAQ, VOC, Gas Resistance, CO2 equivalent
#                  - Sensors organized with proper entity categories
#
# v24 (2025-01-11) - CRITICAL: Fixed image paths for Home Assistant container
#                  - Changed type: RGB24 → RGB (ESPHome 2025.12.5 compatibility)
#                  - Images now use full path: /config/esphome/ (ESPHome add-on container)
#                  - Added comprehensive documentation throughout
#
# v23 (2025-01-10) - Professional Sensors page with background images
#                  - Added visual arc meters and bar graphs for gas sensors
#                  - Converted gas readings from volts to PPM (consumer friendly)
#                  - Added battery charging detection (voltage trend analysis)
#                  - Added overall AQI composite score
#                  - Background images at 50% opacity on both pages
#
# v22 (2025-01-09) - Fixed ADS1115 channel mapping (A0=batt, A1=CO, A2=NH3, A3=NO2)
#                  - Added gas baseline calibration system with flash storage
#                  - Added ratio/delta sensors for gas alerts
#
# ============================================================================
# CURRENT CONFIGURATION
# ============================================================================
# PAGE LAYOUT:
# 
# HOME PAGE (Your Personal Use):
#   - Background: Multisensor-fusion.jpg at 50% opacity
#   - Starlink stats, Kauf smart plugs, WLED controls
#   - Climate data (Garage + Main House BME680 sensors from HA)
#   - Weather forecast display
#   - Navigation buttons to all pages
#
# SENSORS PAGE (For Selling/Marketing) - ⭐ REDESIGNED IN V27:
#   - Background: MiCS-6814 sensor chip image at 50% opacity
#   - TOP ROW (4 compact cards):
#     * Battery status with CHARGING indicator
#     * Overall Air Quality Index (AQI) with color-coded status
#     * Climate (Temperature & Humidity)
#     * CO2 arc meter (400-2000ppm visual gauge from SCD41)
#   - BOTTOM ROW (2 large cards):
#     * BME680 VOC + IAQ Detection (⭐ NOW VISIBLE!)
#       - IAQ Index: 0-500 scale with color zones
#       - VOC Detection: ppm reading
#       - Gas Resistance: kOhm reading
#       - What it detects: Educational descriptions
#     * Gas Safety Detection (MiCS-6814)
#       - CO bar with "! DEADLY GAS" warning
#       - NH3 bar with "Irritant" label
#       - NO2 bar with "Toxic" label
#       - Safety thresholds shown for each gas
#       - Dynamic color coding (Green/Yellow/Red)
#
# To Make Sensors Page Default (When Selling):
#   1. In lvgl: pages: section, swap order
#   2. Make page_sensors first, page_home second
#   3. Or remove page_home entirely for production units
#
# ============================================================================
# HARDWARE WIRING & CONNECTIONS
# ============================================================================
#
# BATTERY SYSTEM:
#   - 10000mAh 1160100 LiPo Cell (3.0V-4.2V)
#   - Connected to ADS1115 A0 through voltage divider
#   - Voltage divider: 200kOhm (top) + 100kOhm (bottom to GND)
#   - Math: Vbattery = Vadc × (300kOhm / 100kOhm) = Vadc × 3.0
#   - Why divider? ESP32 max = 3.3V, battery max = 4.2V
#   - Charging detection: Monitors voltage rise ≥0.010V per 5 seconds
#
# I2C BUS (GPIO8=SDA, GPIO9=SCL @ 100kHz):
#   Device        Address   Purpose
#   --------      -------   -------
#   ADS1115       0x48      4-channel ADC for battery + gas sensors
#   SCD41         0x62      CO2 + Temperature + Humidity (NDIR sensor)
#   BME680        0x77      VOC + IAQ + Temp + Humidity + Pressure ⭐ NEW!
#   CH422G        (GPIO)    Display control expander
#
# ADS1115 CHANNEL MAPPING:
#   A0: Battery voltage (through 200k/100k divider)
#   A1: MiCS-6814 CO (Carbon Monoxide)
#   A2: MiCS-6814 NH3 (Ammonia)
#   A3: MiCS-6814 NO2 (Nitrogen Dioxide)
#
# GAS SENSOR DETAILS (MiCS-6814):
#   - CO:  Detects car exhaust, fires, gas stoves, cigarettes
#          Safe: <50ppm, Danger: >200ppm
#   - NH3: Detects cleaning products, fertilizers, animal waste
#          Safe: <25ppm, Danger: >300ppm
#   - NO2: Detects car exhaust, gas stoves, welding fumes
#          Safe: <0.5ppm, Danger: >1ppm
#   - REQUIRES CALIBRATION in clean outdoor air (press button in HA)
#   - Stores baseline voltages to flash memory (survives reboots)
#   - PPM conversions are simplified approximations for consumers
#
# SCD41 SENSOR:
#   - CO2: 400-5000ppm range, ±40ppm accuracy, NDIR technology
#   - Temp: ±0.8°C accuracy, runs warm (apply offset in settings)
#   - Humidity: ±6% RH accuracy
#   - Auto-calibrates to 400ppm over 7 days
#   - Sample rate: 5 seconds (don't go faster)
#
# BME680 SENSOR (⭐ NEW - JUST INSTALLED):
#   - Gas Resistance: Metal oxide VOC sensor (detects odors, chemicals)
#   - IAQ Index: 0-500 scale (0=excellent, 500=hazardous)
#   - Temperature: ±1°C accuracy (redundant with SCD41, good for validation)
#   - Humidity: ±3% RH accuracy (better than SCD41!)
#   - Pressure: ±1 hPa (for weather prediction, altitude sensing)
#   - CO2 Equivalent: Estimated from VOC (not real CO2, use SCD41 instead)
#   - VOC: Breath VOC in ppm (detects human presence, cooking, cleaners)
#   - Calibration: Auto-calibrates over 5 minutes, saves state every 6 hours
#   - Sample rate: Uses BSEC library (low power mode)
#
# SENSOR COMPARISON (What Each Does Best):
#   SCD41:    Real CO2 (NDIR sensor) ← Use this for CO2!
#   BME680:   VOC detection (cooking, cleaners, odors) ← Use this for IAQ!
#   MiCS-6814: Specific gases (CO, NH3, NO2) ← Use this for safety alerts!
#
# DISPLAY:
#   - 800×480 RGB parallel interface (16-bit color)
#   - GT911 capacitive touch controller
#   - 13MHz pixel clock
#   - Power: ~1.5W typical
#
# ============================================================================
# IMAGE FILES LOCATION (REQUIRED FOR COMPILATION)
# ============================================================================
# These files MUST be in /config/esphome/ directory (ESPHome add-on container path):
#   - bg-home.jpg (145KB) - Home page background
#   - bg-sensor.jpg (19KB) - Sensors page background
#
# First compile takes 5-10 minutes (image processing + resizing)
# Subsequent compiles are fast (images cached)
# ============================================================================

substitutions:
  device_name: "43inch-display"
  friendly_name: "4.3INCH-DISPLAY"
  config_version: "v35"
  
  # Battery Configuration (10000mAh LiPo 1160100 Cell)
  # These values define battery percentage calculation
  # Adjust if using different battery chemistry or capacity
  battery_full_voltage: "4.20"    # 100% charge = 4.20V (LiPo max, never exceed 4.25V!)
  battery_empty_voltage: "3.00"   # 0% charge = 3.00V (never discharge below 2.8V - damage risk)
  battery_capacity_mah: "10000"   # Total capacity in milliamp-hours

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

  # Start the idle timers immediately on boot (otherwise nothing happens until the first touch)
  on_boot:
    priority: -100
    then:
      - output.turn_on: backlight_output
      - script.execute: screensaver_idle_timer
      - script.execute: screenoff_idle_timer
  platformio_options:
    build_flags: "-DBOARD_HAS_PSRAM"
    board_build.arduino.memory_type: qio_opi
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 8MB
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "y"
      CONFIG_SPIRAM_RODATA: "y"

psram:
  mode: octal
  speed: 80MHz

logger:
  level: INFO  # Set to DEBUG for troubleshooting, WARN for production (less logs)

# ============================================================================
# GLOBAL VARIABLES (State Memory Across Reboots)
# ============================================================================
# These variables maintain state between sensor readings and power cycles
# restore_value: true = saved to flash memory (survives reboots)
# restore_value: false = resets to initial_value on every boot
globals:
  # ========== BATTERY CHARGING DETECTION ==========
  # Uses Sensor AD (GPIO6) as a dedicated CHARGING / 5V-present detector
  # Hardware: GPIO6 -> divider 200k (to VCC/5V) and 100k (to GND). Divider ratio = 3.0
  # Logic: if scaled AD voltage indicates ~5V present, we mark the battery as charging.
  
  - id: batt_last_v
    type: float
    restore_value: no  # Fresh start each boot
    initial_value: "0.0"
    # Stores previous battery voltage reading for trend comparison
    
  - id: batt_last_ms
    type: uint32_t
    restore_value: no
    initial_value: "0"
    # Timestamp (milliseconds since boot) of last battery reading
    
  - id: batt_is_charging
    type: bool
    restore_value: no
    initial_value: "false"
    # Current charging state: true = voltage rising, false = stable/falling

  # ========== GAS SENSOR BASELINE CALIBRATION ==========
  # MiCS-6814 requires calibration in clean air to establish reference point
  # User presses "Calibrate Gas Baseline" button when device is outdoors
  # Current voltages are stored as "clean air" reference
  # All future readings compare to these baselines to calculate PPM
  # CRITICAL: These are saved to flash (restore_value: true)
  
  - id: g_baseline_valid
    type: bool
    restore_value: true  # IMPORTANT: Survives reboots!
    initial_value: "false"
    # Has user performed calibration? false = no baseline, sensor shows NAN
    
  - id: g_baseline_nh3_v
    type: float
    restore_value: true  # Saved to flash memory
    initial_value: "0.0"
    # NH3 channel voltage in clean air (ammonia baseline reference)
    # Example: 1.50V stored → future reading 1.80V = 1.20× baseline = ~67ppm
    
  - id: g_baseline_no2_v
    type: float
    restore_value: true
    initial_value: "0.0"
    # NO2 channel voltage in clean air (nitrogen dioxide baseline)
    
  - id: g_baseline_co_v
    type: float
    restore_value: true
    initial_value: "0.0"
    # CO channel voltage in clean air (carbon monoxide baseline)

  # ========== SCREEN SAVER & POWER MANAGEMENT ==========
  # Manages idle timers for screen saver and screen off modes
  # Screen saver shows moving text, screen off completely blacks out display
  
  - id: screensaver_active
    type: bool
    restore_value: no
    initial_value: "false"
    # Is screen saver currently showing? true = saver active, false = normal operation
    
  - id: screen_off
    type: bool
    restore_value: no
    initial_value: "false"
    # Is screen completely off? true = backlight off, false = backlight on
    
  - id: current_page_before_sleep
    type: int
    restore_value: no
    initial_value: "0"
    # Which page was showing before screen saver activated (for wake-up return)
    
  - id: saver_x
    type: int
    restore_value: no
    initial_value: "100"
    # Screen saver text X position (horizontal movement)
    
  - id: saver_y
    type: int
    restore_value: no
    initial_value: "100"
    # Screen saver text Y position (vertical movement)
    
  - id: saver_dx
    type: int
    restore_value: no
    initial_value: "2"
    # Screen saver X velocity (pixels per frame, positive = right, negative = left)
    
  - id: saver_dy
    type: int
    restore_value: no
    initial_value: "2"
    # Screen saver Y velocity (pixels per frame, positive = down, negative = up)

wifi:
  ssid: "BOVENS-MESH"
  password: "605506Jdb"
  ap:
    ssid: "${device_name}"
    password: "fallback123"

captive_portal:

api:
  encryption:
    key: "bjuk1n4Pl7UCotK6ra6hDnaOqFojZhlPDC4LYDD2rC0="
  reboot_timeout: 0s

ota:
  - platform: esphome
    password: "8193f8f4bcb7df0933f89b175002b912"

time:
  - platform: homeassistant
    id: ha_time

# ============================================================================
# I2C BUS CONFIGURATION
# ============================================================================
# Single shared I2C bus for all sensors
# Speed: 100kHz (standard mode) - don't increase, some sensors need slow clock
# All devices listed above share these two wires + power/ground
i2c:
  sda: GPIO8   # I2C Data line (bidirectional communication)
  scl: GPIO9   # I2C Clock line (timing signal)
  scan: true   # Auto-detect devices at boot (helpful for debugging)
  id: bus_a
  frequency: 100kHz  # Standard I2C speed - tested stable with all sensors

# ============================================================================
# HARDWARE COMPONENT INITIALIZATION
# ============================================================================

# ADS1115: Texas Instruments 16-bit Analog-to-Digital Converter
# Why needed? ESP32 has ADC but:
#   - Not accurate enough for battery voltage
#   - Can't handle 0-4.2V range reliably
#   - Limited to certain pins
# ADS1115 provides 4 channels of high-precision analog input
ads1115:
  - id: ads1115_hub
    address: 0x48  # Default I2C address (solder jumpers can change to 0x49/0x4A/0x4B)
    continuous_mode: on  # Constantly samples (faster updates, ~200µA extra current)
    # Alternative: single-shot mode saves power but slower response

# CH422G: GPIO Expander (controls display reset/enable pins)
# This chip adds extra GPIO pins since ESP32-S3 GPIO is limited

# ============================================================================
# BACKLIGHT CONTROL (GPIO2 - PWM)
# ============================================================================
# Waveshare ESP32-S3-LCD-4.3" uses GPIO2 for backlight PWM control

ch422g:
  - id: ch422g_hub

# ===== BACKLIGHT (GPIO2 HARD ON/OFF) =====
output:
  # ============================================================
  # BACKLIGHT — CH422G PIN 0 (HARD ON/OFF, NO PWM)
  # NOTE: GPIO2 is used by the RGB DPI display bus on this board,
  # so backlight MUST be controlled via CH422G.
  # ============================================================
  # ============================================================
  # BACKLIGHT — CH422G IO2 (EXIO2 / LCD_BL) HARD ON/OFF
  # NOTE: Must use CH422G expander; ESP32 GPIO2 is on the DPI bus.
  # ============================================================
  - platform: gpio
    id: backlight_output
    pin:
      ch422g: ch422g_hub
      # IMPORTANT: do NOT share this pin with display.enable_pin or anything else.
      # If you share it, the display driver will keep forcing it ON and you will
      # never be able to turn the backlight off.
      number: 2
      mode:
        output: true
    inverted: false

# ===== BACKLIGHT MANUAL SWITCH (HOME ASSISTANT) =====
# This lets you VERIFY the hardware backlight pin instantly from HA.
# If this switch can't turn the backlight off, the issue is wiring/pin mapping.
switch:
  - platform: output
    name: "Backlight"
    id: backlight_switch
    output: backlight_output
    restore_mode: ALWAYS_ON
    entity_category: config



script:
  # ========== SCREEN SAVER IDLE TIMER ==========
  # Tracks user inactivity and triggers screen saver
  # Resets on every touch event via touchscreen on_touch trigger
  # When timer expires, switches to screen saver page
  
  - id: screensaver_idle_timer
    mode: restart  # Any touch resets the timer to full duration
    then:
      - delay: !lambda 'return id(screensaver_timer_min).state * 60 * 1000;'
      - lambda: |-
          if (id(screensaver_active) || id(screen_off)) return;  // Already asleep
          
          ESP_LOGI("screensaver", "Activating screen saver after %.0f minutes idle", 
                   id(screensaver_timer_min).state);
          id(screensaver_active) = true;
          
          // Reset animation position to center of screen
          id(saver_x) = 100;
          id(saver_y) = 100;
          id(saver_dx) = 2;
          id(saver_dy) = 2;
          
      - lvgl.page.show: page_screensaver
  
  # ========== SCREEN OFF IDLE TIMER ==========
  # Tracks user inactivity and turns off display backlight
  # More aggressive power saving than screen saver
  # When timer expires, backlight turns completely off
  
  - id: screenoff_idle_timer
    mode: restart  # Any touch resets the timer to full duration
    then:
      - delay: !lambda 'return id(screenoff_timer_min).state * 60 * 1000;'
      - lambda: |-
          if (id(screen_off)) return;  // Already off
          
          ESP_LOGI("screenoff", "Turning screen off after %.0f minutes idle", 
                   id(screenoff_timer_min).state);
          id(screen_off) = true;
          id(screensaver_active) = false;  // Not in screensaver mode anymore
      - output.turn_off: backlight_output
          
          
      - lvgl.page.show: page_screenoff

display:
  - platform: rpi_dpi_rgb
    id: my_display
    auto_clear_enabled: false
    color_order: RGB
    pclk_frequency: 13MHz
    dimensions:
      width: 800
      height: 480
    de_pin:
      number: 5
    hsync_pin:
      number: 46
      ignore_strapping_warning: true
    vsync_pin:
      number: 3
      ignore_strapping_warning: true
    pclk_pin: 7
    reset_pin:
      ch422g: ch422g_hub
      number: 3
    pclk_inverted: true
    hsync_back_porch: 43
    hsync_front_porch: 8
    hsync_pulse_width: 10
    vsync_back_porch: 12
    vsync_front_porch: 8
    vsync_pulse_width: 8
    data_pins:
      red:
        - 1
        - 2
        - 42
        - 41
        - 40
      blue:
        - 14
        - 38
        - 18
        - 17
        - 10
      green:
        - 39
        - 0
        - 45
        - 48
        - 47
        - 21

touchscreen:
  platform: gt911
  id: my_touch
  interrupt_pin: GPIO4
  reset_pin:
    ch422g: ch422g_hub
    number: 1
    mode: OUTPUT
# ============================================================================
  on_touch:
    - lambda: |-
        ESP_LOGD("touch", "Touch detected! Resetting idle timers");
        // Reset both idle timers on any touch
        id(screensaver_idle_timer).execute();
        id(screenoff_idle_timer).execute();
    - if:
        condition:
          or:
            - lambda: 'return id(screensaver_active);'
            - lambda: 'return id(screen_off);'
        then:
          - lambda: |-
              ESP_LOGI("screensaver", "Waking from sleep mode");
              id(screensaver_active) = false;
              id(screen_off) = false;
          - output.turn_on: backlight_output
          - lvgl.page.show: page_home

# BACKGROUND IMAGES (50% opacity for readability)
# ============================================================================
# BACKGROUND IMAGES (Professional Appearance for Marketing)
# ============================================================================
# REQUIREMENTS:
#   1. Files MUST exist at these exact paths before compiling
#   2. First compile takes 5-10 minutes (image processing)
#   3. Subsequent compiles are fast (images cached in .esphome folder)
#   4. Images are resized to 800×480 and converted to RGB format
#   5. Embedded in firmware (~300KB total flash usage)
#
# FILE LOCATIONS (using your original uploaded filenames):
#   - /config/esphome/Multisensor-fusion.jpg
#   - /config/esphome/71XPk_GPjPL__AC_UF350_350_QL80_.jpg
#
# USAGE:
#   - bg_home: Displayed on home page at 50% opacity (dark overlay)
#   - bg_sensors: Displayed on sensors page at 50% opacity
#
# NOTE: type changed from RGB24 to RGB for ESPHome 2025.12.5 compatibility

# Fonts
font:
  - file: "gfonts://Roboto@700"
    id: font_title
    size: 30
    bpp: 4
  - file: "gfonts://Roboto@500"
    id: font_xl
    size: 42
    bpp: 4
  - file: "gfonts://Roboto@500"
    id: font_lg
    size: 28
    bpp: 4
  - file: "gfonts://Roboto@400"
    id: font_md
    size: 20
    bpp: 4
  - file: "gfonts://Roboto@400"
    id: font_sm
    size: 15
    bpp: 4
  - file: "gfonts://Roboto@300"
    id: font_xs
    size: 12
    bpp: 4
  - file: "gfonts://Material+Symbols+Outlined"
    id: icons
    size: 36
    bpp: 4
    glyphs:
      - "\U0000e88a" # home
      - "\U0000e1b1" # thermostat (climate)
      - "\U0000e63e" # router (starlink)
      - "\U0000e8b8" # power (plugs)
      - "\U0000e40a" # lightbulb (wled)
      - "\U0000e8b9" # settings cog
      - "\U0000e5c4" # arrow back
      - "\U0000e923" # wifi
      - "\U0000e8ac" # refresh/restart
      - "\U0000e2c4" # cloud_download
      - "\U0000e2c6" # cloud_upload
      - "\U0000eb3b" # ac_unit (snowflake)
      - "\U0000e430" # wb_sunny
      - "\U0000e42d" # wb_cloudy
      - "\U0000e1be" # battery_charging_full
      - "\U0000e1a3" # battery_full
      - "\U0000e32a" # sensors

# ============================================================================
# BUTTONS & USER CONTROLS
# ============================================================================
button:
  - platform: restart
    id: restart_btn
    name: "Restart Display"
    # Reboots ESP32 (available in Home Assistant)
    # Use if: display freezes, WiFi stuck, sensors not updating

  # ========== GAS SENSOR CALIBRATION BUTTON ==========
  # CRITICAL: Read this before pressing!
  #
  # WHAT IT DOES:
  #   - Stores current gas sensor voltages as "clean air" baseline
  #   - All future PPM readings compare to this reference
  #   - Baseline saved to flash memory (survives reboots)
  #
  # WHEN TO CALIBRATE:
  #   1. First time powering on device (MANDATORY)
  #   2. After device off for >24 hours (sensors drift)
  #   3. After moving to new location/altitude
  #   4. If readings seem wrong (recalibrate in known clean air)
  #   5. Monthly for best accuracy
  #
  # HOW TO CALIBRATE (Step-by-Step):
  #   1. Take device OUTSIDE or to room with open windows
  #   2. Avoid: cooking, cars, smoking, cleaners, perfumes
  #   3. Let fresh air circulate for 10+ minutes
  #   4. Power on device, wait 5 minutes (sensor warm-up)
  #   5. In Home Assistant, press "Calibrate Gas Baseline" button
  #   6. Device stores current voltages as reference
  #   7. Done! PPM readings now show values relative to this baseline
  #
  # EXAMPLE:
  #   - Calibration stores: CO = 1.50V (clean air reference)
  #   - Later indoors, CO reads 1.80V
  #   - Ratio = 1.80V / 1.50V = 1.20 (20% above baseline)
  #   - Converts to ~200 ppm CO (moderate detection)
  #
  # TROUBLESHOOTING:
  #   - "All gas readings show 0 ppm" → Not calibrated yet, press button!
  #   - "Readings are negative" → Calibrated in polluted air, redo outside
  #   - "Too sensitive (false alarms)" → Lower alert ratios in HA
  #   - "Not sensitive enough" → Raise alert ratios in HA
  #
  - platform: template
    name: "Calibrate Gas Baseline"
    id: btn_cal_gas_baseline
    entity_category: config
    icon: "mdi:tune"
    on_press:
      - lambda: |-
          // Store current MiCS-6814 channel voltages as baseline reference
          if (id(mics_nh3_v).has_state()) id(g_baseline_nh3_v) = id(mics_nh3_v).state;
          if (id(mics_no2_v).has_state()) id(g_baseline_no2_v) = id(mics_no2_v).state;
          if (id(mics_co_v).has_state())  id(g_baseline_co_v)  = id(mics_co_v).state;
          id(g_baseline_valid) = true;  // Mark baseline as valid
          // Log to ESPHome console for verification
          ESP_LOGI("gas", "✓ Baseline calibration complete!");
          ESP_LOGI("gas", "  NH3: %.3fV | NO2: %.3fV | CO: %.3fV",
                   (float)id(g_baseline_nh3_v), (float)id(g_baseline_no2_v), (float)id(g_baseline_co_v));

# ============================================================================
# ADJUSTABLE SETTINGS (Number Inputs in Home Assistant)
# ============================================================================
# These settings appear in Home Assistant and can be adjusted without reflashing
# All settings saved to flash memory (persist across reboots)
number:
  # ========== GAS ALERT THRESHOLDS ==========
  # Controls when binary sensors trigger alerts in Home Assistant
  # Value = ratio multiplier vs baseline (1.0 = baseline, 2.0 = double)
  #
  # HOW IT WORKS:
  #   - Baseline calibration stores "clean air" voltage (e.g., 1.50V for CO)
  #   - During use, sensor reads current voltage (e.g., 1.65V)
  #   - Ratio calculated: 1.65V / 1.50V = 1.10 (10% above baseline)
  #   - If ratio ≥ alert threshold (default 1.10), binary sensor triggers
  #   - Home Assistant automation can notify you, turn on fans, etc.
  #
  # TUNING GUIDE:
  #   Lower value (e.g., 1.05) = More sensitive, more alerts, catches small changes
  #   Higher value (e.g., 1.20) = Less sensitive, fewer alerts, only big changes
  #
  # RECOMMENDED VALUES:
  #   1.05-1.10: High sensitivity (residential, detect cooking/cleaning)
  #   1.10-1.15: Medium sensitivity (balanced, default)
  #   1.15-1.25: Low sensitivity (industrial, only serious contamination)
  #
  # SAFETY NOTES:
  #   - Don't set too high! You might miss dangerous gas levels
  #   - For CO (carbon monoxide), keep ≤1.15 (can be deadly)
  #   - For NH3/NO2, can be less sensitive (1.15-1.20 OK)
  
  - platform: template
    name: "NH3 Alert Ratio"
    id: nh3_alert_ratio
    entity_category: config
    icon: "mdi:molecule"
    optimistic: true
    restore_value: true
    min_value: 0.80  # 80% of baseline (unusual - would mean voltage DROP)
    max_value: 2.00  # 200% of baseline (double clean air = very high)
    step: 0.01       # Adjust in 1% increments
    initial_value: 1.10  # Default: Alert at 10% above baseline
    # NH3 (Ammonia) - Detects: Cleaners, fertilizer, animal waste
    # Typical alert at 1.10 = ~33ppm ammonia

  - platform: template
    name: "NO2 Alert Ratio"
    id: no2_alert_ratio
    entity_category: config
    icon: "mdi:molecule"
    optimistic: true
    restore_value: true
    min_value: 0.80
    max_value: 2.00
    step: 0.01
    initial_value: 1.10
    # NO2 (Nitrogen Dioxide) - Detects: Car exhaust, gas stoves
    # Typical alert at 1.10 = ~1ppm NO2 (EPA limit is 0.5ppm)

  - platform: template
    name: "CO Alert Ratio"
    id: co_alert_ratio
    entity_category: config
    icon: "mdi:molecule-co"
    optimistic: true
    restore_value: true
    min_value: 0.80
    max_value: 2.00
    step: 0.01
    initial_value: 1.10
    # CO (Carbon Monoxide) - Detects: Fires, car exhaust, gas appliances
    # Typical alert at 1.10 = ~100ppm CO
    # CRITICAL: Keep ≤1.15 for safety! CO is odorless and deadly

  - platform: template
    name: "CO2 Alert Threshold"
    id: co2_alert_threshold
    entity_category: config
    icon: "mdi:molecule-co2"
    optimistic: true
    restore_value: true
    min_value: 800
    max_value: 3000
    step: 50
    initial_value: 2000
    unit_of_measurement: "ppm"
    # CO2 Alert - Triggers when CO2 exceeds this threshold
    # Default 2000 ppm = moderate concern (not dangerous, but stuffy)
    # Adjust based on your ventilation needs

  # ========== TEMPERATURE CALIBRATION ==========
  # SCD41 sensor runs warm due to internal electronics
  # This offset corrects the temperature reading to match reality
  #
  # CALIBRATION PROCEDURE:
  #   1. Get accurate reference thermometer
  #   2. Place both sensors in same location for 30 minutes
  #   3. Compare readings:
  #      - SCD41 shows: 72.5°F
  #      - Reference shows: 70.0°F
  #      - Offset = 70.0 - 72.5 = -2.5°F
  #   4. Set this value to -2.5
  #   5. SCD41 now displays corrected temperature
  #
  # NOTES:
  #   - Offset typically -2°F to -5°F (sensor runs warm)
  #   - May vary with enclosure design and ambient temp
  #   - Re-calibrate if you modify enclosure or add heat sources
  
  - platform: template
    name: "SCD41 Temp Offset (°F)"
    id: scd41_temp_offset_f
    entity_category: config
    icon: "mdi:thermometer"
    optimistic: true
    restore_value: true
    initial_value: -20.0  # Default: -20°F (sensor in hot case)
    min_value: -40        # Can subtract up to 40°F (hot enclosures)
    max_value: 40         # Can add up to 40°F  
    step: 0.1             # Fine adjustment in 0.1°F steps
    unit_of_measurement: "°F"

  - platform: template
    name: "BME680 Temp Offset (°F)"
    id: bme680_temp_offset_f
    entity_category: config
    icon: "mdi:thermometer"
    optimistic: true
    restore_value: true
    initial_value: -20.0  # Default: -20°F (sensor self-heating)
    min_value: -40        # Can subtract up to 40°F (hot enclosures)
    max_value: 40         # Can add up to 40°F  
    step: 0.1             # Fine adjustment in 0.1°F steps
    unit_of_measurement: "°F"

  # ========== SCREEN SAVER & POWER MANAGEMENT TIMERS ==========
  # Controls automatic screen saver activation and screen off timing
  # Adjust these values in Home Assistant to customize idle behavior
  
  - platform: template
    name: "Screen Saver Timer"
    id: screensaver_timer_min
    entity_category: config
    icon: "mdi:clock-outline"
    optimistic: true
    restore_value: true
    initial_value: 5.0      # Default: 5 minutes idle before screen saver
    min_value: 1            # Minimum: 1 minute
    max_value: 30           # Maximum: 30 minutes
    step: 1                 # Adjust in 1 minute increments
    unit_of_measurement: "min"
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_set_screensaver_min
            text: !lambda |-
              char buf[16];
              snprintf(buf, sizeof(buf), "%.0f min", id(screensaver_timer_min).state);
              return std::string(buf);

    # Time of inactivity before screen saver activates
    # Screen saver shows moving "TotalSense by Jeremy Boven" text
  
  - platform: template
    name: "Screen Off Timer"
    id: screenoff_timer_min
    entity_category: config
    icon: "mdi:monitor-off"
    optimistic: true
    restore_value: true
    initial_value: 15.0     # Default: 15 minutes idle before screen turns off
    min_value: 5            # Minimum: 5 minutes
    max_value: 60           # Maximum: 60 minutes (1 hour)
    step: 5                 # Adjust in 5 minute increments
    unit_of_measurement: "min"
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_set_screenoff_min
            text: !lambda |-
              char buf[16];
              snprintf(buf, sizeof(buf), "%.0f min", id(screenoff_timer_min).state);
              return std::string(buf);

    # Time of inactivity before backlight turns completely off
    # Saves power when display not in use

# ============================================================================
# SENSORS
# ============================================================================
sensor:

  # ============================================================
  # SENSOR AD — VOLTAGE MONITOR (200k to VCC / 100k to GND)
  # Divider ratio = 3.0
  # ============================================================
  - platform: adc
    pin: GPIO6
    id: sensor_ad_raw
    attenuation: 12db
    update_interval: 5s
    accuracy_decimals: 3
    internal: true

  - platform: template
    name: "Sensor AD Voltage"
    id: sensor_ad_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    lambda: |-
      // 200k (VCC) / 100k (GND) divider
      // ADC sees 1/3 of actual voltage
      return id(sensor_ad_raw).state * 3.0;
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_set_sensor_ad
            text: !lambda |-
              char buf[20];
              snprintf(buf, sizeof(buf), "AD: %.2f V", x);
              return std::string(buf);

  # ========== YOUR HOME ASSISTANT SENSORS (unchanged) ==========
  - platform: homeassistant
    id: starlink_dl
    entity_id: sensor.starlink_downlink_throughput
  - platform: homeassistant
    id: starlink_ul
    entity_id: sensor.starlink_uplink_throughput
  - platform: homeassistant
    id: starlink_pwr
    entity_id: sensor.starlink_power

  - platform: homeassistant
    id: garage_temp
    entity_id: sensor.bme680_sensor_temperature
  - platform: homeassistant
    id: garage_hum
    entity_id: sensor.bme680_sensor_humidity
  - platform: homeassistant
    id: garage_pres
    entity_id: sensor.bme680_sensor_pressure
  - platform: homeassistant
    id: garage_iaq
    entity_id: sensor.bme680_sensor_indoor_air_quality

  - platform: homeassistant
    id: house_temp
    entity_id: sensor.bme680_2_temperature
  - platform: homeassistant
    id: house_hum
    entity_id: sensor.bme680_2_humidity
  - platform: homeassistant
    id: house_pres
    entity_id: sensor.bme680_2_pressure
  - platform: homeassistant
    id: house_voc
    entity_id: sensor.bme680_2_volatile_organic_compounds

  - platform: homeassistant
    id: weather_temp
    entity_id: weather.forecast_home_2
    attribute: temperature
  - platform: homeassistant
    id: weather_humidity
    entity_id: weather.forecast_home_2
    attribute: humidity
  - platform: homeassistant
    id: weather_wind
    entity_id: weather.forecast_home_2
    attribute: wind_speed

  # ========== LOCAL DIAGNOSTICS ==========
  - platform: wifi_signal
    name: "WiFi Signal (dBm)"
    id: wifi_rssi
    update_interval: 60s
    entity_category: diagnostic

  - platform: template
    name: "WiFi Signal (%)"
    id: wifi_pct
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 60s
    entity_category: diagnostic
    lambda: |-
      if (!id(wifi_rssi).has_state()) return NAN;
      float r = id(wifi_rssi).state;
      float pct = (r + 100.0f) * 2.0f;
      if (pct < 0) pct = 0;
      if (pct > 100) pct = 100;
      return pct;

  - platform: uptime
    name: "Uptime (seconds)"
    id: uptime_sec
    update_interval: 60s
    entity_category: diagnostic

  # ========== BATTERY (10000mAh on ADS1115 A0) ==========
  - platform: ads1115
    ads1115_id: ads1115_hub
    multiplexer: A0_GND
    gain: 4.096
    name: "Battery VSENSE (A0) ADC Volts"
    id: batt_adc_v
    unit_of_measurement: V
    accuracy_decimals: 3
    update_interval: 2s
    entity_category: diagnostic
    disabled_by_default: true
    internal: true
    filters:
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

  - platform: template
    name: "Battery Voltage"
    id: battery_voltage
    unit_of_measurement: V
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 2s
    icon: "mdi:battery"
    lambda: |-
      if (!id(batt_adc_v).has_state()) return NAN;
      // Voltage divider 200k/100k: Vbatt = Vadc * 3.0
      return id(batt_adc_v).state * 3.0f;

  - platform: template
    name: "Battery %"
    id: battery_pct
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    accuracy_decimals: 0
    update_interval: 2s
    icon: "mdi:battery-medium"
    lambda: |-
      if (!id(battery_voltage).has_state()) return NAN;
      float v = id(battery_voltage).state;
      float pct = (v - ${battery_empty_voltage}) / (${battery_full_voltage} - ${battery_empty_voltage}) * 100.0f;
      if (pct < 0) pct = 0;
      if (pct > 100) pct = 100;
      return pct;

  - platform: template
    name: "Battery Capacity Remaining"
    id: battery_mah
    unit_of_measurement: "mAh"
    accuracy_decimals: 0
    update_interval: 2s
    icon: "mdi:battery-heart"
    entity_category: diagnostic
    lambda: |-
      if (!id(battery_pct).has_state()) return NAN;
      return id(battery_pct).state * ${battery_capacity_mah} / 100.0f;

  # ========== MiCS-6814 GAS SENSOR (ADS1115 A1/A2/A3) ==========
  - platform: ads1115
    ads1115_id: ads1115_hub
    multiplexer: A1_GND
    gain: 4.096
    name: "MiCS-6814 CO (A1) Volts"
    id: mics_co_v
    unit_of_measurement: V
    accuracy_decimals: 3
    update_interval: 1s
    icon: "mdi:molecule-co"
    disabled_by_default: false
    filters:
      # HARDWARE FIX NEEDED: Loose A1 connection causes intermittent readings
      # These filters are a temporary workaround - RESEAT THE A1 WIRE!
      - clamp:
          min_value: 0.05  # Reject obvious bad connections (0V readings)
          max_value: 1.5   # Reject impossible voltage spikes
      - median:
          window_size: 5   # Filter out single glitch readings
          send_every: 1
      - sliding_window_moving_average:
          window_size: 20  # Slower response, smoother readings
          send_every: 1

  - platform: ads1115
    ads1115_id: ads1115_hub
    multiplexer: A2_GND
    gain: 4.096
    name: "MiCS-6814 NH3 (A2) Volts"
    id: mics_nh3_v
    unit_of_measurement: V
    accuracy_decimals: 3
    update_interval: 1s
    icon: "mdi:molecule"
    disabled_by_default: false
    filters:
      - median:
          window_size: 5   # Remove noise spikes
          send_every: 1
      - sliding_window_moving_average:
          window_size: 20  # Slower response, smoother readings
          send_every: 1

  - platform: ads1115
    ads1115_id: ads1115_hub
    multiplexer: A3_GND
    gain: 4.096
    name: "MiCS-6814 NO2 (A3) Volts"
    id: mics_no2_v
    unit_of_measurement: V
    accuracy_decimals: 3
    update_interval: 1s
    icon: "mdi:molecule"
    disabled_by_default: false
    filters:
      - median:
          window_size: 5   # Remove noise spikes
          send_every: 1
      - sliding_window_moving_average:
          window_size: 20  # Slower response, smoother readings
          send_every: 1

  # ========== GAS PPM CONVERSIONS (Consumer-friendly) ==========
  - platform: template
    name: "Carbon Monoxide (CO)"
    id: gas_co_ppm
    unit_of_measurement: "ppm"
    icon: "mdi:molecule-co"
    state_class: measurement
    accuracy_decimals: 0
    update_interval: 2s
    lambda: |-
      if (!id(mics_co_v).has_state() || !id(g_baseline_valid)) return NAN;
      float ratio = id(mics_co_v).state / (id(g_baseline_co_v) > 0.01 ? id(g_baseline_co_v) : 0.5);
      // Simple approximation: ratio 1.0 = 0ppm, ratio 2.0 = 1000ppm
      float ppm = (ratio - 1.0f) * 1000.0f;
      if (ppm < 0) ppm = 0;
      if (ppm > 1000) ppm = 1000;
      return ppm;

  - platform: template
    name: "Ammonia (NH3)"
    id: gas_nh3_ppm
    unit_of_measurement: "ppm"
    icon: "mdi:molecule"
    state_class: measurement
    accuracy_decimals: 0
    update_interval: 2s
    lambda: |-
      if (!id(mics_nh3_v).has_state() || !id(g_baseline_valid)) return NAN;
      float ratio = id(mics_nh3_v).state / (id(g_baseline_nh3_v) > 0.01 ? id(g_baseline_nh3_v) : 0.5);
      // Approximate: ratio 1.0 = 0ppm, ratio 2.5 = 500ppm
      float ppm = (ratio - 1.0f) * 333.0f;
      if (ppm < 0) ppm = 0;
      if (ppm > 500) ppm = 500;
      return ppm;

  - platform: template
    name: "Nitrogen Dioxide (NO2)"
    id: gas_no2_ppm
    unit_of_measurement: "ppm"
    icon: "mdi:molecule"
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 2s
    lambda: |-
      if (!id(mics_no2_v).has_state() || !id(g_baseline_valid)) return NAN;
      float ratio = id(mics_no2_v).state / (id(g_baseline_no2_v) > 0.01 ? id(g_baseline_no2_v) : 0.5);
      // Approximate: ratio 1.0 = 0ppm, ratio 3.0 = 20ppm
      float ppm = (ratio - 1.0f) * 10.0f;
      if (ppm < 0) ppm = 0;
      if (ppm > 20) ppm = 20;
      return ppm;

  # Delta and Ratio sensors (for alerts)
  - platform: template
    name: "NH3 Delta from Baseline"
    id: mics_nh3_delta
    unit_of_measurement: V
    accuracy_decimals: 3
    icon: "mdi:delta"
    entity_category: diagnostic
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_nh3_v).has_state()) return NAN;
      return id(mics_nh3_v).state - id(g_baseline_nh3_v);

  - platform: template
    name: "NH3 Ratio vs Baseline"
    id: mics_nh3_ratio
    accuracy_decimals: 2
    icon: "mdi:percent"
    entity_category: diagnostic
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_nh3_v).has_state()) return NAN;
      if (id(g_baseline_nh3_v) == 0.0f) return NAN;
      return id(mics_nh3_v).state / id(g_baseline_nh3_v);

  - platform: template
    name: "NO2 Delta from Baseline"
    id: mics_no2_delta
    unit_of_measurement: V
    accuracy_decimals: 3
    icon: "mdi:delta"
    entity_category: diagnostic
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_no2_v).has_state()) return NAN;
      return id(mics_no2_v).state - id(g_baseline_no2_v);

  - platform: template
    name: "NO2 Ratio vs Baseline"
    id: mics_no2_ratio
    accuracy_decimals: 2
    icon: "mdi:percent"
    entity_category: diagnostic
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_no2_v).has_state()) return NAN;
      if (id(g_baseline_no2_v) == 0.0f) return NAN;
      return id(mics_no2_v).state / id(g_baseline_no2_v);

  - platform: template
    name: "CO Delta from Baseline"
    id: mics_co_delta
    unit_of_measurement: V
    accuracy_decimals: 3
    icon: "mdi:delta"
    entity_category: diagnostic
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_co_v).has_state()) return NAN;
      return id(mics_co_v).state - id(g_baseline_co_v);

  - platform: template
    name: "CO Ratio vs Baseline"
    id: mics_co_ratio
    accuracy_decimals: 2
    icon: "mdi:percent"
    entity_category: diagnostic
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_co_v).has_state()) return NAN;
      if (id(g_baseline_co_v) == 0.0f) return NAN;
      return id(mics_co_v).state / id(g_baseline_co_v);

  # ========== SCD41 (CO2 + Temp + Humidity) ==========
  - platform: scd4x
    i2c_id: bus_a
    address: 0x62
    update_interval: 5s
    co2:
      name: "SCD41 CO2"
      id: scd41_co2
      unit_of_measurement: "ppm"
      accuracy_decimals: 0
      icon: "mdi:molecule-co2"
      filters:
        - sliding_window_moving_average:
            window_size: 6
            send_every: 1
    temperature:
      name: "SCD41 Temperature (C) Raw"
      id: scd41_temp_c
      accuracy_decimals: 2
      entity_category: diagnostic
      disabled_by_default: true
    humidity:
      name: "SCD41 Humidity"
      id: scd41_hum
      unit_of_measurement: "%"
      accuracy_decimals: 1
      icon: "mdi:water-percent"

  - platform: template
    name: "SCD41 Temperature"
    id: scd41_temp_f
    unit_of_measurement: "°F"
    accuracy_decimals: 1
    update_interval: 5s
    icon: "mdi:thermometer"
    device_class: temperature
    state_class: measurement
    lambda: |-
      if (!id(scd41_temp_c).has_state()) return NAN;
      float f = id(scd41_temp_c).state * 9.0f/5.0f + 32.0f;
      if (id(scd41_temp_offset_f).has_state()) f += id(scd41_temp_offset_f).state;
      return f;

  # ========== BME680 ENVIRONMENTAL + VOC SENSOR ⭐ NEW! ==========
  - platform: bme680
    i2c_id: bus_a
    address: 0x77
    update_interval: 5s

    temperature:
      name: "Display BME680 Temperature"
      id: bme680_temp
      accuracy_decimals: 1
      entity_category: diagnostic

    humidity:
      name: "Display BME680 Humidity"
      id: bme680_hum
      accuracy_decimals: 1

    pressure:
      name: "Display BME680 Pressure"
      id: bme680_press
      accuracy_decimals: 1

    gas_resistance:
      name: "Display BME680 Gas Resistance"
      id: bme680_gas
      entity_category: diagnostic

  # ===== "BSEC-like" derived metrics (trend / UI-friendly) =====
  - platform: template
    name: "Display BME680 IAQ"
    id: bme680_iaq
    unit_of_measurement: "IAQ"
    icon: "mdi:air-filter"
    accuracy_decimals: 0
    update_interval: 5s
    lambda: |-
      if (!id(bme680_gas).has_state()) return NAN;

      // Gas resistance in Ohms: higher = cleaner air, lower = more VOCs.
      // Map resistance to a 0..500 "IAQ-like" score:
      //   gas_min -> 500 (bad)
      //   gas_max ->   0 (good)
      const float gas_min = 10000.0f;    // adjust if you see values below this
      const float gas_max = 300000.0f;   // adjust if you see values above this

      float g = id(bme680_gas).state;
      if (g < gas_min) g = gas_min;
      if (g > gas_max) g = gas_max;

      float clean_pct = (g - gas_min) / (gas_max - gas_min);  // 0..1
      float iaq = 500.0f * (1.0f - clean_pct);

      if (iaq < 0) iaq = 0;
      if (iaq > 500) iaq = 500;
      return iaq;

  - platform: template
    name: "Display BME680 IAQ Accuracy"
    id: bme680_iaq_accuracy
    entity_category: diagnostic
    accuracy_decimals: 0
    update_interval: 10s
    lambda: |-
      // Plain BME680 has no BSEC accuracy flag.
      // Simple warm-up indicator:
      // 0 = warming up (<5 min), 1 = stable (>=5 min)
      if (!id(uptime_sec).has_state()) return 0;
      return (id(uptime_sec).state < 300) ? 0 : 1;

  - platform: template
    name: "Display BME680 CO2 Equivalent"
    id: bme680_eco2
    unit_of_measurement: "ppm"
    accuracy_decimals: 0
    entity_category: diagnostic
    update_interval: 5s
    lambda: |-
      if (!id(bme680_iaq).has_state()) return NAN;

      // Marketing-style estimate: IAQ 0..500 -> eCO2 400..2000 ppm (rough trend)
      float iaq = id(bme680_iaq).state;
      float eco2 = 400.0f + (iaq / 500.0f) * 1600.0f;

      if (eco2 < 400) eco2 = 400;
      if (eco2 > 5000) eco2 = 5000;
      return eco2;

  - platform: template
    name: "Display BME680 VOC"
    id: bme680_voc
    unit_of_measurement: "ppm"
    accuracy_decimals: 1
    update_interval: 5s
    lambda: |-
      if (!id(bme680_iaq).has_state()) return NAN;

      // Rough VOC trend: IAQ 0..500 -> VOC 0..10 ppm
      float iaq = id(bme680_iaq).state;
      float voc = (iaq / 500.0f) * 10.0f;

      if (voc < 0) voc = 0;
      if (voc > 50) voc = 50;
      return voc;

  - platform: template
    name: "Display BME680 Temperature (°F)"
    id: bme680_temp_f
    unit_of_measurement: "°F"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 5s
    lambda: |-
      if (!id(bme680_temp).has_state()) return NAN;
      float temp_c = id(bme680_temp).state;
      float temp_f = temp_c * 9.0f/5.0f + 32.0f;
      // Apply user-configurable offset
      if (id(bme680_temp_offset_f).has_state()) {
        temp_f += id(bme680_temp_offset_f).state;
      }
      return temp_f;
      
binary_sensor:
  - platform: homeassistant
    id: starlink_conn
    entity_id: binary_sensor.starlink_connectivity

  - platform: template
    name: "Battery Charging (AD GPIO6)"
    id: batt_charging
    device_class: battery_charging
    entity_category: diagnostic
    lambda: |-
      // Charging present when Sensor AD (GPIO6) indicates ~5V input
      return id(batt_is_charging);

  - platform: template
    name: "NH3 Alert"
    id: bs_nh3_alert
    device_class: problem
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_nh3_ratio).has_state()) return false;
      return id(mics_nh3_ratio).state >= id(nh3_alert_ratio).state;

  - platform: template
    name: "NO2 Alert"
    id: bs_no2_alert
    device_class: problem
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_no2_ratio).has_state()) return false;
      return id(mics_no2_ratio).state >= id(no2_alert_ratio).state;

  - platform: template
    name: "CO Alert"
    id: bs_co_alert
    device_class: problem
    lambda: |-
      if (!id(g_baseline_valid) || !id(mics_co_ratio).has_state()) return false;
      return id(mics_co_ratio).state >= id(co_alert_ratio).state;

  - platform: template
    name: "CO2 Alert"
    id: alert_co2
    device_class: problem
    icon: "mdi:alert"
    lambda: |-
      if (!id(scd41_co2).has_state()) return false;
      return id(scd41_co2).state > id(co2_alert_threshold).state;

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP"
      id: wifi_ip
    ssid:
      name: "SSID"
      id: wifi_ssid
    bssid:
      name: "BSSID"
      id: wifi_bssid
    mac_address:
      name: "MAC"
      id: wifi_mac

  - platform: homeassistant
    id: weather_condition
    entity_id: weather.forecast_home_2

  - platform: template
    name: "Air Quality Status"
    id: aqi_status
    icon: "mdi:air-filter"
    update_interval: 5s
    lambda: |-
      if (!id(garage_iaq).has_state()) return {"Unknown"};
      float aqi = id(garage_iaq).state;
      if (aqi <= 150) return {"Good"};
      if (aqi <= 300) return {"Moderate"};
      if (aqi <= 400) return {"Unhealthy (Sensitive)"};
      if (aqi <= 500) return {"Unhealthy"};
      return {"Hazardous"};

# ============================================================================
# LVGL UI
# ============================================================================
lvgl:
  displays:
    - my_display
  touchscreens:
    - my_touch
  buffer_size: 10%

  style_definitions:
    - id: style_card
      bg_color: 0x16213e
      bg_opa: 95%
      radius: 12
      pad_all: 12
      border_width: 0
    - id: style_card_transparent
      bg_color: 0x16213e
      bg_opa: 75%
      radius: 15
      pad_all: 15
      border_width: 2
      border_color: 0x38bdf8
      border_opa: 40%
    - id: style_btn
      bg_color: 0x0f3460
      radius: 10
      pad_all: 10
      text_color: 0xffffff
    - id: style_header
      bg_color: 0x16213e
      bg_opa: 90%
      radius: 0
      pad_left: 15
      pad_right: 15

  # Start the idle timers when LVGL is ready
  on_idle:
    timeout: 10s  # Wait 10 seconds after boot before starting timers
    then:
      - script.execute: screensaver_idle_timer
      - script.execute: screenoff_idle_timer

  pages:
    # ========================================================================
    # HOME PAGE (YOUR ORIGINAL PERSONAL DASHBOARD - UNCHANGED FROM v26)
    # ========================================================================
    - id: page_home
      bg_color: 0x1a1a2e
      scrollbar_mode: "OFF"
      widgets:
        # Background image at 50% opacity

        # Header bar
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - label:
                  id: lbl_time
                  text: "12:00 PM"
                  text_font: font_lg
                  text_color: 0xffffff
                  align: LEFT_MID
              - label:
                  id: lbl_date
                  text: "Mon, Jan 1"
                  text_font: font_sm
                  text_color: 0x888888
                  align: LEFT_MID
                  x: 130
              - label:
                  text: "\U0000e923"
                  text_font: icons
                  id: lbl_wifi_icon
                  text_color: 0x4ade80
                  align: RIGHT_MID

        # Quick stat cards
        - obj:
            styles: style_card
            width: 245
            height: 95
            x: 15
            y: 65
            widgets:
              - label:
                  text: "Garage Apt"
                  text_font: font_sm
                  text_color: 0x888888
              - label:
                  id: lbl_h_gar_t
                  text: "--.-°F"
                  text_font: font_xl
                  text_color: 0xffffff
                  align: CENTER
                  y: 8
              - label:
                  id: lbl_h_gar_h
                  text: "--%"
                  text_font: font_sm
                  text_color: 0x888888
                  align: BOTTOM_RIGHT

        - obj:
            styles: style_card
            width: 245
            height: 95
            x: 275
            y: 65
            widgets:
              - label:
                  text: "Main House"
                  text_font: font_sm
                  text_color: 0x888888
              - label:
                  id: lbl_h_house_t
                  text: "--.-°F"
                  text_font: font_xl
                  text_color: 0xffffff
                  align: CENTER
                  y: 8
              - label:
                  id: lbl_h_house_h
                  text: "--%"
                  text_font: font_sm
                  text_color: 0x888888
                  align: BOTTOM_RIGHT

        - obj:
            styles: style_card
            width: 245
            height: 95
            x: 535
            y: 65
            bg_color: 0x0a1628
            widgets:
              - label:
                  text: "\U0000e63e"
                  text_font: icons
                  text_color: 0x1d9bf0
                  x: 0
                  y: 0
              - label:
                  text: "Starlink"
                  text_font: font_sm
                  text_color: 0x1d9bf0
                  x: 42
                  y: 8
              - label:
                  id: lbl_h_dl
                  text: "-- Mbps"
                  text_font: font_lg
                  text_color: 0xffffff
                  align: CENTER
                  y: 10

        # Navigation grid - Row 1
        - button:
            styles: style_btn
            width: 175
            height: 115
            x: 15
            y: 175
            widgets:
              - label:
                  text: "\U0000e1b1"
                  text_font: icons
                  text_color: 0x4ade80
                  align: TOP_MID
                  y: 12
              - label:
                  text: "Climate"
                  text_font: font_md
                  text_color: 0xffffff
                  align: BOTTOM_MID
                  y: -12
            on_click:
              - lvgl.page.show: page_climate

        - button:
            styles: style_btn
            width: 175
            height: 115
            x: 205
            y: 175
            widgets:
              - label:
                  text: "\U0000e63e"
                  text_font: icons
                  text_color: 0x1d9bf0
                  align: TOP_MID
                  y: 12
              - label:
                  text: "Starlink"
                  text_font: font_md
                  text_color: 0xffffff
                  align: BOTTOM_MID
                  y: -12
            on_click:
              - lvgl.page.show: page_starlink

        - button:
            styles: style_btn
            width: 175
            height: 115
            x: 395
            y: 175
            widgets:
              - label:
                  text: "\U0000e8b8"
                  text_font: icons
                  text_color: 0xfbbf24
                  align: TOP_MID
                  y: 12
              - label:
                  text: "Plugs"
                  text_font: font_md
                  text_color: 0xffffff
                  align: BOTTOM_MID
                  y: -12
            on_click:
              - lvgl.page.show: page_plugs

        - button:
            styles: style_btn
            width: 175
            height: 115
            x: 585
            y: 175
            widgets:
              - label:
                  text: "\U0000e40a"
                  text_font: icons
                  text_color: 0xff6b35
                  align: TOP_MID
                  y: 12
              - label:
                  text: "WLED"
                  text_font: font_md
                  text_color: 0xffffff
                  align: BOTTOM_MID
                  y: -12
            on_click:
              - lvgl.page.show: page_wled

        # Navigation grid - Row 2
        - button:
            styles: style_btn
            width: 175
            height: 115
            x: 15
            y: 305
            widgets:
              - label:
                  id: lbl_h_weather_icon
                  text: "\U0000e42d"
                  text_font: icons
                  text_color: 0x38bdf8
                  align: TOP_MID
                  y: 8
              - label:
                  text: "Weather"
                  text_font: font_md
                  text_color: 0xffffff
                  align: BOTTOM_MID
                  y: -12
            on_click:
              - lvgl.page.show: page_weather

        - button:
            styles: style_btn
            width: 175
            height: 115
            x: 205
            y: 305
            widgets:
              - label:
                  text: "\U0000e8b9"
                  text_font: icons
                  text_color: 0x888888
                  align: TOP_MID
                  y: 12
              - label:
                  text: "Settings"
                  text_font: font_md
                  text_color: 0xffffff
                  align: BOTTOM_MID
                  y: -12
            on_click:
              - lvgl.page.show: page_settings

        - button:
            styles: style_btn
            width: 175
            height: 115
            x: 395
            y: 305
            widgets:
              - label:
                  text: "\U0000e32a"
                  text_font: icons
                  text_color: 0xa78bfa
                  align: TOP_MID
                  y: 12
              - label:
                  text: "Sensors"
                  text_font: font_md
                  text_color: 0xffffff
                  align: BOTTOM_MID
                  y: -12
            on_click:
              - lvgl.page.show: page_sensors

        - button:
            styles: style_btn
            width: 175
            height: 115
            x: 585
            y: 305
            widgets:
              - label:
                  text: "\U0000e32a"
                  text_font: icons
                  text_color: 0x10b981
                  align: TOP_MID
                  y: 12
              - label:
                  text: "RAW"
                  text_font: font_md
                  text_color: 0xffffff
                  align: BOTTOM_MID
                  y: -12
            on_click:
              - lvgl.page.show: page_raw

        # Bottom status
        - label:
            id: lbl_h_ip
            text: "IP: Connecting..."
            text_font: font_sm
            text_color: 0x555555
            x: 15
            y: 440

    # ========================================================================
    # CLIMATE PAGE (unchanged from v26)
    # ========================================================================
    - id: page_climate
      bg_color: 0x1a1a2e
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - button:
                  styles: style_btn
                  width: 55
                  height: 40
                  align: LEFT_MID
                  widgets:
                    - label:
                        text: "\U0000e5c4"
                        text_font: icons
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lvgl.page.show: page_home
              - label:
                  text: "Climate"
                  text_font: font_lg
                  text_color: 0x4ade80
                  align: CENTER

        # Garage Apartment Card
        - obj:
            styles: style_card
            width: 380
            height: 200
            x: 15
            y: 70
            widgets:
              - label:
                  text: "Garage Apartment"
                  text_font: font_md
                  text_color: 0xffffff
              - label:
                  text: "Temperature"
                  text_font: font_sm
                  text_color: 0x666666
                  y: 40
              - label:
                  id: lbl_c_gar_t
                  text: "--.-°F"
                  text_font: font_xl
                  text_color: 0xffffff
                  y: 60
              - label:
                  text: "Humidity"
                  text_font: font_sm
                  text_color: 0x666666
                  x: 180
                  y: 40
              - label:
                  id: lbl_c_gar_h
                  text: "--%"
                  text_font: font_lg
                  text_color: 0xffffff
                  x: 180
                  y: 60
              - label:
                  text: "Pressure"
                  text_font: font_sm
                  text_color: 0x666666
                  y: 120
              - label:
                  id: lbl_c_gar_p
                  text: "-- hPa"
                  text_font: font_md
                  text_color: 0xffffff
                  y: 140
              - label:
                  text: "Air Quality (IAQ)"
                  text_font: font_sm
                  text_color: 0x666666
                  x: 180
                  y: 120
              - label:
                  id: lbl_c_gar_iaq
                  text: "--"
                  text_font: font_md
                  text_color: 0x4ade80
                  x: 180
                  y: 140

        # Main House Card
        - obj:
            styles: style_card
            width: 380
            height: 200
            x: 405
            y: 70
            widgets:
              - label:
                  text: "Main House"
                  text_font: font_md
                  text_color: 0xffffff
              - label:
                  text: "Temperature"
                  text_font: font_sm
                  text_color: 0x666666
                  y: 40
              - label:
                  id: lbl_c_house_t
                  text: "--.-°F"
                  text_font: font_xl
                  text_color: 0xffffff
                  y: 60
              - label:
                  text: "Humidity"
                  text_font: font_sm
                  text_color: 0x666666
                  x: 180
                  y: 40
              - label:
                  id: lbl_c_house_h
                  text: "--%"
                  text_font: font_lg
                  text_color: 0xffffff
                  x: 180
                  y: 60
              - label:
                  text: "Pressure"
                  text_font: font_sm
                  text_color: 0x666666
                  y: 120
              - label:
                  id: lbl_c_house_p
                  text: "-- hPa"
                  text_font: font_md
                  text_color: 0xffffff
                  y: 140
              - label:
                  text: "VOC"
                  text_font: font_sm
                  text_color: 0x666666
                  x: 180
                  y: 120
              - label:
                  id: lbl_c_house_v
                  text: "--"
                  text_font: font_md
                  text_color: 0x4ade80
                  x: 180
                  y: 140

        # IAQ Legend
        - obj:
            styles: style_card
            width: 770
            height: 60
            x: 15
            y: 285
            bg_color: 0x0f1a2e
            widgets:
              - label:
                  text: "IAQ Scale:"
                  text_font: font_sm
                  text_color: 0x888888
                  align: LEFT_MID
                  x: 10
              - label:
                  text: "0-50 Good"
                  text_font: font_sm
                  text_color: 0x4ade80
                  align: LEFT_MID
                  x: 100
              - label:
                  text: "51-100 OK"
                  text_font: font_sm
                  text_color: 0xfbbf24
                  align: LEFT_MID
                  x: 200
              - label:
                  text: "101-150 Fair"
                  text_font: font_sm
                  text_color: 0xf97316
                  align: LEFT_MID
                  x: 300
              - label:
                  text: "151-200 Poor"
                  text_font: font_sm
                  text_color: 0xef4444
                  align: LEFT_MID
                  x: 420
              - label:
                  text: "200+ Bad"
                  text_font: font_sm
                  text_color: 0xdc2626
                  align: LEFT_MID
                  x: 550

    # ========================================================================
    # STARLINK PAGE (unchanged from v26)
    # ========================================================================
    - id: page_starlink
      bg_color: 0x1a1a2e
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - button:
                  styles: style_btn
                  width: 55
                  height: 40
                  align: LEFT_MID
                  widgets:
                    - label:
                        text: "\U0000e5c4"
                        text_font: icons
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lvgl.page.show: page_home
              - label:
                  text: "Starlink"
                  text_font: font_lg
                  text_color: 0x1d9bf0
                  align: CENTER

        # Status bar
        - obj:
            styles: style_card
            width: 770
            height: 65
            x: 15
            y: 70
            bg_color: 0x0a1628
            widgets:
              - label:
                  text: "Status:"
                  text_font: font_md
                  text_color: 0xffffff
                  align: LEFT_MID
                  x: 10
              - label:
                  id: lbl_s_status
                  text: "Checking..."
                  text_font: font_md
                  text_color: 0xfbbf24
                  align: LEFT_MID
                  x: 90
              - label:
                  id: lbl_s_pwr
                  text: "-- W"
                  text_font: font_md
                  text_color: 0x888888
                  align: RIGHT_MID
                  x: -10

        # Download card with icon
        - obj:
            styles: style_card
            width: 375
            height: 160
            x: 15
            y: 150
            widgets:
              - label:
                  text: "\U0000e2c4"
                  text_font: icons
                  text_color: 0x4ade80
                  align: TOP_MID
                  y: 5
              - label:
                  text: "Download"
                  text_font: font_md
                  text_color: 0x4ade80
                  align: TOP_MID
                  y: 40
              - label:
                  id: lbl_s_dl
                  text: "--"
                  text_font: font_xl
                  text_color: 0xffffff
                  align: CENTER
                  y: 15
              - label:
                  text: "Mbps"
                  text_font: font_sm
                  text_color: 0x888888
                  align: BOTTOM_MID
                  y: -15

        # Upload card with icon
        - obj:
            styles: style_card
            width: 375
            height: 160
            x: 410
            y: 150
            widgets:
              - label:
                  text: "\U0000e2c6"
                  text_font: icons
                  text_color: 0x38bdf8
                  align: TOP_MID
                  y: 5
              - label:
                  text: "Upload"
                  text_font: font_md
                  text_color: 0x38bdf8
                  align: TOP_MID
                  y: 40
              - label:
                  id: lbl_s_ul
                  text: "--"
                  text_font: font_xl
                  text_color: 0xffffff
                  align: CENTER
                  y: 15
              - label:
                  text: "Mbps"
                  text_font: font_sm
                  text_color: 0x888888
                  align: BOTTOM_MID
                  y: -15

    # ========================================================================
    # PLUGS PAGE (unchanged from v26 - keeping your full 15-plug config)
    # ========================================================================
    - id: page_plugs
      bg_color: 0x1a1a2e
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - button:
                  styles: style_btn
                  width: 55
                  height: 40
                  align: LEFT_MID
                  widgets:
                    - label:
                        text: "\U0000e5c4"
                        text_font: icons
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lvgl.page.show: page_home
              - label:
                  text: "Kauf Smart Plugs (12)"
                  text_font: font_lg
                  text_color: 0xfbbf24
                  align: CENTER

        # 3 columns x 5 rows
        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 10
            y: 70
            checkable: true
            widgets:
              - label:
                  text: "Basement Plants #1"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_120b26_kauf_plug"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 270
            y: 70
            checkable: true
            widgets:
              - label:
                  text: "Basement Plants #2"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_5"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 530
            y: 70
            checkable: true
            widgets:
              - label:
                  text: "Basement Plants #3"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_3"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 10
            y: 135
            checkable: true
            widgets:
              - label:
                  text: "Overhead Grow #4"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_4"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 270
            y: 135
            checkable: true
            widgets:
              - label:
                  text: "Plug #5"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_2"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 530
            y: 135
            checkable: true
            widgets:
              - label:
                  text: "Double Doors #6"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_d674a6_kauf_plug"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 10
            y: 200
            checkable: true
            widgets:
              - label:
                  text: "Mouii Purple #7"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_d674de_kauf_plug"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 270
            y: 200
            checkable: true
            widgets:
              - label:
                  text: "Loft Plants #8"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_12cf89_kauf_plug"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 530
            y: 200
            checkable: true
            widgets:
              - label:
                  text: "Loft Plants #9"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_12ac14_kauf_plug"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 10
            y: 265
            checkable: true
            widgets:
              - label:
                  text: "Plug #10"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_6"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 270
            y: 265
            checkable: true
            widgets:
              - label:
                  text: "Plug #11"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_7"

        - button:
            styles: style_btn
            width: 250
            height: 60
            x: 530
            y: 265
            checkable: true
            widgets:
              - label:
                  text: "Plug #12"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service:
                  service: switch.toggle
                  data:
                    entity_id: "switch.kauf_plug_8"



        # All On/Off buttons
        - button:
            styles: style_btn
            width: 380
            height: 60
            x: 10
            y: 400
            bg_color: 0x166534
            widgets:
              - label:
                  text: "ALL ON"
                  text_font: font_md
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_120b26_kauf_plug" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_5" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_3" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_4" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_2" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_6" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_7" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_8" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_9" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_10" } }
              - homeassistant.service: { service: switch.turn_on, data: { entity_id: "switch.kauf_plug_11" } }

        - button:
            styles: style_btn
            width: 380
            height: 60
            x: 400
            y: 400
            bg_color: 0x991b1b
            widgets:
              - label:
                  text: "ALL OFF"
                  text_font: font_md
                  text_color: 0xffffff
                  align: CENTER
            on_click:
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_120b26_kauf_plug" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_5" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_3" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_4" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_2" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_6" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_7" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_8" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_9" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_10" } }
              - homeassistant.service: { service: switch.turn_off, data: { entity_id: "switch.kauf_plug_11" } }

    # ========================================================================
    # WLED PAGE (unchanged from v26)
    # ========================================================================
    - id: page_wled
      bg_color: 0x1a1a2e
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - button:
                  styles: style_btn
                  width: 55
                  height: 40
                  align: LEFT_MID
                  widgets:
                    - label:
                        text: "\U0000e5c4"
                        text_font: icons
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lvgl.page.show: page_home
              - label:
                  text: "WLED Presets"
                  text_font: font_lg
                  text_color: 0xff6b35
                  align: CENTER

        # LEFT controller card
        - obj:
            styles: style_card
            width: 380
            height: 360
            x: 15
            y: 70
            widgets:
              - label:
                  text: "LEFT"
                  text_font: font_lg
                  text_color: 0xff6b35
              - button:
                  styles: style_btn
                  width: 170
                  height: 55
                  x: 10
                  y: 55
                  widgets:
                    - label: { text: "TOGGLE", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: light.toggle
                        data:
                          entity_id: "light.wled_left"

              - button:
                  styles: style_btn
                  width: 170
                  height: 55
                  x: 200
                  y: 55
                  bg_color: 0xffffff
                  widgets:
                    - label: { text: "WHITE", text_font: font_md, text_color: 0x000000, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: light.turn_on
                        data:
                          entity_id: "light.wled_left"
                          color_name: "white"
                          brightness_pct: "100"

              # Preset buttons
              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 10
                  y: 125
                  widgets:
                    - label: { text: "20", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_left_preset"
                          option: "20"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 135
                  y: 125
                  widgets:
                    - label: { text: "25", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_left_preset"
                          option: "25"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 260
                  y: 125
                  widgets:
                    - label: { text: "30", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_left_preset"
                          option: "30"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 10
                  y: 190
                  widgets:
                    - label: { text: "35", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_left_preset"
                          option: "35"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 135
                  y: 190
                  widgets:
                    - label: { text: "40", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_left_preset"
                          option: "40"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 260
                  y: 190
                  widgets:
                    - label: { text: "45", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_left_preset"
                          option: "45"

              - label:
                  text: "IP: 192.168.68.67"
                  text_font: font_sm
                  text_color: 0x888888
                  align: BOTTOM_LEFT
                  y: -8

        # RIGHT controller card
        - obj:
            styles: style_card
            width: 380
            height: 360
            x: 405
            y: 70
            widgets:
              - label:
                  text: "RIGHT"
                  text_font: font_lg
                  text_color: 0xff6b35
              - button:
                  styles: style_btn
                  width: 170
                  height: 55
                  x: 10
                  y: 55
                  widgets:
                    - label: { text: "TOGGLE", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: light.toggle
                        data:
                          entity_id: "light.wled_right"

              - button:
                  styles: style_btn
                  width: 170
                  height: 55
                  x: 200
                  y: 55
                  bg_color: 0xffffff
                  widgets:
                    - label: { text: "WHITE", text_font: font_md, text_color: 0x000000, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: light.turn_on
                        data:
                          entity_id: "light.wled_right"
                          color_name: "white"
                          brightness_pct: "100"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 10
                  y: 125
                  widgets:
                    - label: { text: "20", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_right_preset"
                          option: "20"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 135
                  y: 125
                  widgets:
                    - label: { text: "25", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_right_preset"
                          option: "25"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 260
                  y: 125
                  widgets:
                    - label: { text: "30", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_right_preset"
                          option: "30"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 10
                  y: 190
                  widgets:
                    - label: { text: "35", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_right_preset"
                          option: "35"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 135
                  y: 190
                  widgets:
                    - label: { text: "40", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_right_preset"
                          option: "40"

              - button:
                  styles: style_btn
                  width: 110
                  height: 55
                  x: 260
                  y: 190
                  widgets:
                    - label: { text: "45", text_font: font_md, text_color: 0xffffff, align: CENTER }
                  on_click:
                    - homeassistant.service:
                        service: select.select_option
                        data:
                          entity_id: "select.wled_right_preset"
                          option: "45"

              - label:
                  text: "IP: 192.168.68.62"
                  text_font: font_sm
                  text_color: 0x888888
                  align: BOTTOM_LEFT
                  y: -8

    # ========================================================================
    # WEATHER PAGE (unchanged from v26)
    # ========================================================================
    - id: page_weather
      bg_color: 0x1a1a2e
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - button:
                  styles: style_btn
                  width: 55
                  height: 40
                  align: LEFT_MID
                  widgets:
                    - label:
                        text: "\U0000e5c4"
                        text_font: icons
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lvgl.page.show: page_home
              - label:
                  text: "Weather"
                  text_font: font_lg
                  text_color: 0x38bdf8
                  align: CENTER

        # Current conditions card
        - obj:
            styles: style_card
            width: 380
            height: 200
            x: 15
            y: 70
            widgets:
              - label:
                  id: lbl_w_icon
                  text: "\U0000e42d"
                  text_font: icons
                  text_color: 0x38bdf8
                  align: TOP_MID
                  y: -8
              - label:
                  id: lbl_w_cond
                  text: "Loading..."
                  text_font: font_md
                  text_color: 0xffffff
                  align: TOP_MID
                  y: 65
              - label:
                  id: lbl_w_temp
                  text: "--°F"
                  text_font: font_xl
                  text_color: 0xffffff
                  align: CENTER
                  y: 20

        # Additional weather info
        - obj:
            styles: style_card
            width: 380
            height: 200
            x: 405
            y: 70
            widgets:
              - label:
                  text: "Humidity"
                  text_font: font_sm
                  text_color: 0x666666
                  y: 20
              - label:
                  id: lbl_w_hum
                  text: "--%"
                  text_font: font_lg
                  text_color: 0xffffff
                  y: 45
              - label:
                  text: "Wind Speed"
                  text_font: font_sm
                  text_color: 0x666666
                  y: 100
              - label:
                  id: lbl_w_wind
                  text: "--"
                  text_font: font_lg
                  text_color: 0xffffff
                  y: 125

        # Entity info
        - obj:
            styles: style_card
            width: 770
            height: 60
            x: 15
            y: 285
            bg_color: 0x0f1a2e
            widgets:
              - label:
                  text: "Entity: weather.forecast_home_2"
                  text_font: font_sm
                  text_color: 0x888888
                  align: CENTER

    # ========================================================================
    # SENSORS PAGE v27 - ⭐ THIS IS THE ONLY PAGE THAT CHANGED! ⭐
    # ========================================================================
    - id: page_sensors
      bg_color: 0x000000
      scrollbar_mode: "OFF"
      widgets:
        # Background image at 50% opacity

        # Header
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - button:
                  styles: style_btn
                  width: 55
                  height: 40
                  align: LEFT_MID
                  widgets:
                    - label:
                        text: "\U0000e5c4"
                        text_font: icons
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lvgl.page.show: page_home
              - label:
                  text: "AIR QUALITY & SAFETY MONITOR"
                  text_font: font_title
                  text_color: 0x38bdf8
                  align: CENTER

        # ===== TOP ROW: 4 COMPACT STATUS CARDS =====
        
        # Card 1: Battery (top-left)
        - obj:
            styles: style_card_transparent
            width: 150
            height: 110
            x: 10
            y: 65
            widgets:
              - label:
                  id: lbl_s_batt_icon
                  text: "\U0000e1a3"
                  text_font: icons
                  text_color: 0x4ade80
                  align: TOP_MID
                  y: 5
              - label:
                  id: lbl_s_battery
                  text: "85%"
                  text_font: font_lg
                  text_color: 0xffffff
                  align: CENTER
                  y: 5
              - label:
                  id: lbl_s_batt_status
                  text: "READY"
                  text_font: font_xs
                  text_color: 0x4ade80
                  align: BOTTOM_MID
                  y: -8

        # Card 2: Overall AQI
        - obj:
            styles: style_card_transparent
            width: 210
            height: 110
            x: 170
            y: 65
            widgets:
              - label:
                  text: "OVERALL AQI"
                  text_font: font_sm
                  text_color: 0x888888
                  align: TOP_MID
                  y: 5
              - label:
                  id: lbl_s_aqi
                  text: "45"
                  text_font: font_xl
                  text_color: 0x4ade80
                  align: CENTER
                  y: 0
              - label:
                  id: lbl_s_aqi_status
                  text: "Good"
                  text_font: font_sm
                  text_color: 0x4ade80
                  align: BOTTOM_MID
                  y: -8

        # Card 3: Climate
        - obj:
            styles: style_card_transparent
            width: 150
            height: 110
            x: 390
            y: 65
            widgets:
              - label:
                  text: "CLIMATE"
                  text_font: font_sm
                  text_color: 0x888888
                  align: TOP_MID
                  y: 5
              - label:
                  id: lbl_s_temp
                  text: "72°F"
                  text_font: font_lg
                  text_color: 0xfbbf24
                  align: CENTER
                  y: 0
              - label:
                  id: lbl_s_humidity
                  text: "45%"
                  text_font: font_sm
                  text_color: 0x38bdf8
                  align: BOTTOM_MID
                  y: -8

        # Card 4: CO2 Arc Meter (compact version)
        - obj:
            styles: style_card_transparent
            width: 240
            height: 110
            x: 550
            y: 65
            widgets:
              - label:
                  text: "CO2 SENSOR"
                  text_font: font_sm
                  text_color: 0xffffff
                  align: TOP_LEFT
                  x: 5
                  y: 5
              - arc:
                  id: arc_co2
                  x: 10
                  y: 25
                  width: 70
                  height: 70
                  start_angle: 135
                  end_angle: 45
                  rotation: 0
                  value: 650
                  min_value: 400
                  max_value: 6000
                  adjustable: false
                  arc_color: 0x2a2a3e
                  arc_width: 8
                  indicator:
                    arc_color: 0x4ade80
                    arc_width: 8
              - label:
                  id: lbl_s_co2_value
                  text: "650"
                  text_font: font_md
                  text_color: 0xffffff
                  x: 90
                  y: 35
              - label:
                  text: "ppm"
                  text_font: font_xs
                  text_color: 0x888888
                  x: 90
                  y: 55
              - label:
                  id: lbl_s_co2_status
                  text: "Excellent"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 90
                  y: 70

        # ===== BOTTOM ROW: 2 LARGE SENSOR DETAIL CARDS =====

        # Card 5: BME680 VOC + IAQ DETECTION ⭐ NOW VISIBLE!
        - obj:
            styles: style_card_transparent
            width: 390
            height: 290
            x: 10
            y: 185
            widgets:
              - label:
                  text: "BME680 VOC + IAQ"
                  text_font: font_md
                  text_color: 0xffffff
                  y: 5
              - label:
                  text: "Bosch environmental sensor"
                  text_font: font_xs
                  text_color: 0x888888
                  y: 25
              
              # IAQ Index
              - label:
                  text: "Indoor Air Quality (IAQ)"
                  text_font: font_sm
                  text_color: 0x666666
                  y: 50
              - label:
                  id: lbl_s_bme680_iaq
                  text: "45"
                  text_font: font_xl
                  text_color: 0x4ade80
                  x: 15
                  y: 70
              - label:
                  text: "/500"
                  text_font: font_sm
                  text_color: 0x666666
                  x: 80
                  y: 90
              
              # IAQ Scale
              - label:
                  text: "0-150 Good"
                  text_font: font_xs
                  text_color: 0x4ade80
                  x: 150
                  y: 65
              - label:
                  text: "151-300 OK"
                  text_font: font_xs
                  text_color: 0xfbbf24
                  x: 150
                  y: 80
              - label:
                  text: "301-400 Fair"
                  text_font: font_xs
                  text_color: 0xf97316
                  x: 150
                  y: 95
              - label:
                  text: ">400 Poor"
                  text_font: font_xs
                  text_color: 0xef4444
                  x: 150
                  y: 110

              # VOC Reading
              - label:
                  text: "VOC (Volatile Organic Compounds)"
                  text_font: font_sm
                  text_color: 0x666666
                  y: 135
              - label:
                  id: lbl_s_bme680_voc
                  text: "0.5 ppm"
                  text_font: font_lg
                  text_color: 0x4ade80
                  x: 15
                  y: 155

              # Gas Resistance
              - label:
                  text: "Gas Resistance:"
                  text_font: font_xs
                  text_color: 0x666666
                  x: 15
                  y: 190
              - label:
                  id: lbl_s_bme680_gas
                  text: "250 kOhm"
                  text_font: font_sm
                  text_color: 0x888888
                  x: 120
                  y: 188

              # What it detects
              - label:
                  text: "Detects: Cooking odors, smoke,"
                  text_font: font_xs
                  text_color: 0x555555
                  y: 215
              - label:
                  text: "cleaning products, perfumes,"
                  text_font: font_xs
                  text_color: 0x555555
                  y: 230
              - label:
                  text: "paint fumes, off-gassing"
                  text_font: font_xs
                  text_color: 0x555555
                  y: 245
              
              - label:
                  text: "BME680 @ 0x77"
                  text_font: font_xs
                  text_color: 0x444444
                  align: BOTTOM_RIGHT
                  x: -10
                  y: -8

        # Card 6: GAS SAFETY DETECTION (Enhanced)
        - obj:
            styles: style_card_transparent
            width: 390
            height: 290
            x: 410
            y: 185
            widgets:
              - label:
                  text: "GAS SAFETY DETECTION"
                  text_font: font_md
                  text_color: 0xffffff
                  y: 5
              - label:
                  text: "MiCS-6814 multi-gas sensor"
                  text_font: font_xs
                  text_color: 0x888888
                  y: 25
              
              # CO Bar with DEADLY warning
              - label:
                  text: "CO (Carbon Monoxide)"
                  text_font: font_sm
                  text_color: 0xffffff
                  x: 10
                  y: 50
              - label:
                  text: "! DEADLY GAS"
                  text_font: font_xs
                  text_color: 0xff6b6b
                  align: RIGHT_MID
                  x: -10
                  y: 52
              - bar:
                  id: bar_s_co
                  x: 10
                  y: 70
                  width: 280
                  height: 25
                  min_value: 0
                  max_value: 500
                  value: 10
                  indicator:
                    bg_color: 0x4ade80
                  bg_color: 0x2a2a3e
              - label:
                  id: lbl_s_co_ppm
                  text: "10 ppm"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 300
                  y: 72
              - label:
                  id: lbl_s_co_volts
                  text: "215 mV"
                  text_font: font_xs
                  text_color: 0x666666
                  x: 300
                  y: 88
              - label:
                  text: "Safe: <50  Warning: 50-200  Danger: >200"
                  text_font: font_xs
                  text_color: 0x666666
                  x: 10
                  y: 100
              
              # NH3 Bar
              - label:
                  text: "NH3 (Ammonia)"
                  text_font: font_sm
                  text_color: 0xffffff
                  x: 10
                  y: 125
              - label:
                  text: "Irritant"
                  text_font: font_xs
                  text_color: 0xfbbf24
                  align: RIGHT_MID
                  x: -10
                  y: 127
              - bar:
                  id: bar_s_nh3
                  x: 10
                  y: 145
                  width: 280
                  height: 25
                  min_value: 0
                  max_value: 200
                  value: 5
                  indicator:
                    bg_color: 0x4ade80
                  bg_color: 0x2a2a3e
              - label:
                  id: lbl_s_nh3_ppm
                  text: "5 ppm"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 300
                  y: 147
              - label:
                  id: lbl_s_nh3_volts
                  text: "26 mV"
                  text_font: font_xs
                  text_color: 0x666666
                  x: 300
                  y: 163
              - label:
                  text: "Safe: <25  Warning: 25-100  Danger: >100"
                  text_font: font_xs
                  text_color: 0x666666
                  x: 10
                  y: 175
              
              # NO2 Bar
              - label:
                  text: "NO2 (Nitrogen Dioxide)"
                  text_font: font_sm
                  text_color: 0xffffff
                  x: 10
                  y: 200
              - label:
                  text: "Toxic"
                  text_font: font_xs
                  text_color: 0xa78bfa
                  align: RIGHT_MID
                  x: -10
                  y: 202
              - bar:
                  id: bar_s_no2
                  x: 10
                  y: 220
                  width: 280
                  height: 25
                  min_value: 0
                  max_value: 50
                  value: 0
                  indicator:
                    bg_color: 0x4ade80
                  bg_color: 0x2a2a3e
              - label:
                  id: lbl_s_no2_ppm
                  text: "0.2 ppm"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 300
                  y: 222
              - label:
                  id: lbl_s_no2_volts
                  text: "10 mV"
                  text_font: font_xs
                  text_color: 0x666666
                  x: 300
                  y: 238
              - label:
                  text: "Safe: <0.5  Warning: 0.5-2  Danger: >2"
                  text_font: font_xs
                  text_color: 0x666666
                  x: 10
                  y: 250

              # Calibration reminder
              - label:
                  text: "! Requires baseline calibration"
                  text_font: font_xs
                  text_color: 0xfbbf24
                  align: BOTTOM_LEFT
                  x: 10
                  y: -8

    # ========================================================================
    # SETTINGS PAGE (unchanged from v26)
    # ========================================================================
    - id: page_settings
      bg_color: 0x1a1a2e
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - button:
                  styles: style_btn
                  width: 55
                  height: 40
                  align: LEFT_MID
                  widgets:
                    - label:
                        text: "\U0000e5c4"
                        text_font: icons
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lvgl.page.show: page_home
              - label:
                  text: "Settings"
                  text_font: font_lg
                  text_color: 0xffffff
                  align: CENTER

        # Device info
        - obj:
            styles: style_card
            width: 380
            height: 300
            x: 15
            y: 70
            widgets:
              - label:
                  text: "\U0000e8b9"
                  text_font: icons
                  text_color: 0x888888
              - label:
                  text: "Device Info"
                  text_font: font_lg
                  text_color: 0xffffff
                  x: 45
              - label:
                  text: "Waveshare ESP32-S3 4.3\""
                  text_font: font_sm
                  text_color: 0x888888
                  y: 45
              - label:
                  text: "800 x 480 Touch Display"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 65
              - label:
                  id: lbl_set_ip
                  text: "IP: Connecting..."
                  text_font: font_md
                  text_color: 0xffffff
                  y: 100
              - label:
                  id: lbl_set_wifi
                  text: "WiFi: --"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 130
              - label:
                  id: lbl_set_wifi2
                  text: "WiFi: --"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 150
              - label:
                  id: lbl_set_up
                  text: "Uptime: --"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 175

              - label:
                  id: lbl_set_sensor_ad
                  text: "AD: --.- V"
                  text_font: font_sm
                  text_color: 8947848
                  y: 255
              - label:
                  text: "Battery: 10000mAh"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 200
              - label:
                  text: "Sensors: MiCS-6814, SCD41, BME680"
                  text_font: font_xs
                  text_color: 0x666666
                  y: 225


        # Display Timers Card (with controls!)
        - obj:
            styles: style_card
            width: 380
            height: 170
            x: 15
            y: 210
            widgets:
              - label:
                  text: "\U0000e923"
                  text_font: icons
                  text_color: 0xfbbf24
              - label:
                  text: "Display Timers"
                  text_font: font_lg
                  text_color: 0xffffff
                  x: 45
              - label:
                  text: "Screen Saver:"
                  text_font: font_sm
                  text_color: 0xfbbf24
                  y: 50

              - button:
                  styles: style_btn
                  width: 45
                  height: 45
                  x: 150
                  y: 45
                  bg_color: 0x374151
                  widgets:
                    - label:
                        text: "-"
                        text_font: font_lg
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lambda: |-
                        float nv = id(screensaver_timer_min).state - 1;
                        if (nv < 1) nv = 1;
                        if (nv > 30) nv = 30;
                        id(screensaver_timer_min).publish_state(nv);
                    - lvgl.label.update:
                        id: lbl_set_screensaver_min
                        text: !lambda |-
                          char buf[16];
                          snprintf(buf, sizeof(buf), "%.0f min", id(screensaver_timer_min).state);
                          return std::string(buf);
              - label:
                  id: lbl_set_screensaver_min
                  text: "5 min"
                  text_font: font_md
                  text_color: 0xffffff
                  x: 205
                  y: 55
              - button:
                  styles: style_btn
                  width: 45
                  height: 45
                  x: 305
                  y: 45
                  bg_color: 0x374151
                  widgets:
                    - label:
                        text: "+"
                        text_font: font_lg
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lambda: |-
                        float nv = id(screensaver_timer_min).state + 1;
                        if (nv < 1) nv = 1;
                        if (nv > 30) nv = 30;
                        id(screensaver_timer_min).publish_state(nv);
                    - lvgl.label.update:
                        id: lbl_set_screensaver_min
                        text: !lambda |-
                          char buf[16];
                          snprintf(buf, sizeof(buf), "%.0f min", id(screensaver_timer_min).state);
                          return std::string(buf);
              - label:
                  text: "Screen Off:"
                  text_font: font_sm
                  text_color: 0xf97316
                  y: 105

              - button:
                  styles: style_btn
                  width: 45
                  height: 45
                  x: 150
                  y: 100
                  bg_color: 0x374151
                  widgets:
                    - label:
                        text: "-"
                        text_font: font_lg
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lambda: |-
                        float nv = id(screenoff_timer_min).state - 5;
                        if (nv < 5) nv = 5;
                        if (nv > 60) nv = 60;
                        id(screenoff_timer_min).publish_state(nv);
                    - lvgl.label.update:
                        id: lbl_set_screenoff_min
                        text: !lambda |-
                          char buf[16];
                          snprintf(buf, sizeof(buf), "%.0f min", id(screenoff_timer_min).state);
                          return std::string(buf);
              - label:
                  id: lbl_set_screenoff_min
                  text: "15 min"
                  text_font: font_md
                  text_color: 0xffffff
                  x: 205
                  y: 110
              - button:
                  styles: style_btn
                  width: 45
                  height: 45
                  x: 305
                  y: 100
                  bg_color: 0x374151
                  widgets:
                    - label:
                        text: "+"
                        text_font: font_lg
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lambda: |-
                        float nv = id(screenoff_timer_min).state + 5;
                        if (nv < 5) nv = 5;
                        if (nv > 60) nv = 60;
                        id(screenoff_timer_min).publish_state(nv);
                    - lvgl.label.update:
                        id: lbl_set_screenoff_min
                        text: !lambda |-
                          char buf[16];
                          snprintf(buf, sizeof(buf), "%.0f min", id(screenoff_timer_min).state);
                          return std::string(buf);
        # Actions
        - obj:
            styles: style_card
            width: 380
            height: 300
            x: 405
            y: 70
            widgets:
              - label:
                  text: "\U0000e8ac"
                  text_font: icons
                  text_color: 0x888888
              - label:
                  text: "Actions"
                  text_font: font_lg
                  text_color: 0xffffff
                  x: 45
              - button:
                  styles: style_btn
                  width: 340
                  height: 55
                  x: 10
                  y: 60
                  bg_color: 0x0f3460
                  widgets:
                    - label:
                        text: "Calibrate Gas Sensors"
                        text_font: font_md
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - button.press: btn_cal_gas_baseline
              - button:
                  styles: style_btn
                  width: 340
                  height: 55
                  x: 10
                  y: 130
                  bg_color: 0x991b1b
                  widgets:
                    - label:
                        text: "Restart Display"
                        text_font: font_md
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - button.press: restart_btn
              - label:
                  text: "ESPHome v2025.12.5 / UI v38"
                  text_font: font_sm
                  text_color: 0x555555
                  align: BOTTOM_MID
                  y: -10


    # ========================================================================


    # PAGE: SCREEN SAVER
    # ========================================================================
    # Displays moving "TotalSense by Jeremy Boven" text on black background
    # Activates automatically after configured idle time
    # Touch anywhere to return to home page
    
    - id: page_screensaver
      bg_color: 0x000000  # Pure black background (power saving)
      scrollbar_mode: "OFF"
      widgets:
        - label:
            id: lbl_screensaver
            text: "TotalSense\nby Jeremy Boven"
            x: 100
            y: 100
            text_font: font_xl
            text_color: 0xFFFFFF
            text_align: CENTER

    # ========================================================================
    # PAGE: SCREEN OFF
    # ========================================================================
    # Completely black page shown when screen off timer expires
    # No text, no widgets - just pure black for maximum power saving
    # Touch anywhere to return to home page
    
    - id: page_screenoff
      bg_color: 0x000000  # Pure black background
      scrollbar_mode: "OFF"
      widgets: []  # No widgets - completely blank


    # ========================================================================
    # RAW SENSOR DATA PAGE
    # ========================================================================
    - id: page_raw
      bg_color: 0x1a1a2e
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            width: 800
            height: 55
            styles: style_header
            widgets:
              - button:
                  styles: style_btn
                  width: 55
                  height: 40
                  align: LEFT_MID
                  widgets:
                    - label:
                        text: "\U0000e5c4"
                        text_font: icons
                        text_color: 0xffffff
                        align: CENTER
                  on_click:
                    - lvgl.page.show: page_home
              - label:
                  text: "RAW Sensor Data"
                  text_font: font_lg
                  text_color: 0xffffff
                  align: CENTER

        # MiCS-6814 Gas Sensor Raw Data
        - obj:
            styles: style_card
            width: 380
            height: 190
            x: 15
            y: 70
            widgets:
              - label:
                  text: "MiCS-6814 Gas Sensor"
                  text_font: font_md
                  text_color: 0xffffff
                  y: 5
              - label:
                  text: "CO (A1):"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 40
              - label:
                  id: lbl_raw_co_v
                  text: "215 mV"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 200
                  y: 40
              - label:
                  text: "NH3 (A2):"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 65
              - label:
                  id: lbl_raw_nh3_v
                  text: "26 mV"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 200
                  y: 65
              - label:
                  text: "NO2 (A3):"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 90
              - label:
                  id: lbl_raw_no2_v
                  text: "10 mV"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 200
                  y: 90
              - label:
                  text: "Baseline:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 120
              - label:
                  id: lbl_raw_baseline
                  text: "Valid"
                  text_font: font_xs
                  text_color: 0x10b981
                  x: 200
                  y: 120
              - label:
                  text: "CO Ratio:"
                  text_font: font_xs
                  text_color: 0x666666
                  y: 145
              - label:
                  id: lbl_raw_co_ratio
                  text: "1.05"
                  text_font: font_xs
                  text_color: 0x888888
                  x: 200
                  y: 145

        # BME680 Environmental Sensor Raw Data
        - obj:
            styles: style_card
            width: 380
            height: 190
            x: 405
            y: 70
            widgets:
              - label:
                  text: "BME680 Environmental"
                  text_font: font_md
                  text_color: 0xffffff
                  y: 5
              - label:
                  text: "Gas Resistance:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 40
              - label:
                  id: lbl_raw_bme_gas
                  text: "250 kOhm"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 200
                  y: 40
              - label:
                  text: "IAQ:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 65
              - label:
                  id: lbl_raw_bme_iaq
                  text: "403"
                  text_font: font_sm
                  text_color: 0xf97316
                  x: 200
                  y: 65
              - label:
                  text: "IAQ Accuracy:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 90
              - label:
                  id: lbl_raw_bme_iaq_acc
                  text: "0 (Learning)"
                  text_font: font_sm
                  text_color: 0xfbbf24
                  x: 200
                  y: 90
              - label:
                  text: "Temp (Raw):"
                  text_font: font_xs
                  text_color: 0x666666
                  y: 120
              - label:
                  id: lbl_raw_bme_temp
                  text: "85.6°F"
                  text_font: font_xs
                  text_color: 0x888888
                  x: 200
                  y: 120
              - label:
                  text: "Pressure:"
                  text_font: font_xs
                  text_color: 0x666666
                  y: 145
              - label:
                  id: lbl_raw_bme_press
                  text: "29.64 inHg"
                  text_font: font_xs
                  text_color: 0x888888
                  x: 200
                  y: 145

        # SCD41 CO2 Sensor Raw Data
        - obj:
            styles: style_card
            width: 380
            height: 140
            x: 15
            y: 270
            widgets:
              - label:
                  text: "SCD41 CO2 Sensor"
                  text_font: font_md
                  text_color: 0xffffff
                  y: 5
              - label:
                  text: "CO2:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 40
              - label:
                  id: lbl_raw_scd_co2
                  text: "2400 ppm"
                  text_font: font_sm
                  text_color: 0xf97316
                  x: 200
                  y: 40
              - label:
                  text: "Temp (Raw):"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 65
              - label:
                  id: lbl_raw_scd_temp
                  text: "90.0°F"
                  text_font: font_sm
                  text_color: 0x888888
                  x: 200
                  y: 65
              - label:
                  text: "Humidity:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 90
              - label:
                  id: lbl_raw_scd_hum
                  text: "45%"
                  text_font: font_sm
                  text_color: 0x888888
                  x: 200
                  y: 90

        # Battery ADC Raw Data
        - obj:
            styles: style_card
            width: 380
            height: 140
            x: 405
            y: 270
            widgets:
              - label:
                  text: "ADS1115 Battery ADC"
                  text_font: font_md
                  text_color: 0xffffff
                  y: 5
              - label:
                  text: "ADC Voltage:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 40
              - label:
                  id: lbl_raw_batt_adc
                  text: "1.35 V"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 200
                  y: 40
              - label:
                  text: "Battery V:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 65
              - label:
                  id: lbl_raw_batt_v
                  text: "4.05 V"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 200
                  y: 65
              - label:
                  text: "Percentage:"
                  text_font: font_sm
                  text_color: 0x888888
                  y: 90
              - label:
                  id: lbl_raw_batt_pct
                  text: "85%"
                  text_font: font_sm
                  text_color: 0x4ade80
                  x: 200
                  y: 90


# ============================================================================
# INTERVAL UPDATES
# ============================================================================
interval:
  - interval: 1s
    then:
      - lvgl.label.update:
          id: lbl_time
          text: !lambda |-
            auto t = id(ha_time).now();
            if (t.is_valid()) return t.strftime("%I:%M %p");
            return std::string("--:--");
      - lvgl.label.update:
          id: lbl_date
          text: !lambda |-
            auto t = id(ha_time).now();
            if (t.is_valid()) return t.strftime("%a, %b %d");
            return std::string("---");

  - interval: 5s
    then:
      # Battery charging detection (GPIO6 Sensor AD = 5V present)
      # Sensor AD is scaled by 3.0 (200k to VCC / 100k to GND).
      # We use hysteresis so noise doesn't chatter the state.
      - lambda: |-
          if (id(sensor_ad_voltage).has_state()) {
            const float v_in = id(sensor_ad_voltage).state;  // scaled to real volts
            // Hysteresis thresholds (tweak if your divider/ADC differs)
            const float ON_TH  = 4.40f;  // >= 4.40V -> charging present
            const float OFF_TH = 4.00f;  // <= 4.00V -> not charging
            if (!id(batt_is_charging) && v_in >= ON_TH)  id(batt_is_charging) = true;
            if ( id(batt_is_charging) && v_in <= OFF_TH) id(batt_is_charging) = false;
          } else {
            // If we can't read AD, fail-safe to "not charging"
            id(batt_is_charging) = false;
          }
      - binary_sensor.template.publish:
          id: batt_charging
          state: !lambda 'return id(batt_is_charging);'
      
      # ===== HOME PAGE UPDATES =====
      - lvgl.label.update:
          id: lbl_h_ip
          text: !lambda |-
            if (id(wifi_ip).has_state()) return "IP: " + id(wifi_ip).state;
            return std::string("IP: Connecting...");
      - lvgl.label.update:
          id: lbl_h_gar_t
          text: !lambda |-
            if (id(garage_temp).has_state()) return str_sprintf("%.1f°F", id(garage_temp).state);
            return std::string("--.-°F");
      - lvgl.label.update:
          id: lbl_h_gar_h
          text: !lambda |-
            if (id(garage_hum).has_state()) return str_sprintf("%.0f%%", id(garage_hum).state);
            return std::string("--%");
      - lvgl.label.update:
          id: lbl_h_house_t
          text: !lambda |-
            if (id(house_temp).has_state()) return str_sprintf("%.1f°F", id(house_temp).state);
            return std::string("--.-°F");
      - lvgl.label.update:
          id: lbl_h_house_h
          text: !lambda |-
            if (id(house_hum).has_state()) return str_sprintf("%.0f%%", id(house_hum).state);
            return std::string("--%");
      - lvgl.label.update:
          id: lbl_h_dl
          text: !lambda |-
            if (id(starlink_dl).has_state()) return str_sprintf("%.0f Mbps", id(starlink_dl).state);
            return std::string("-- Mbps");
      - lvgl.label.update:
          id: lbl_h_weather_icon
          text: !lambda |-
            if (!id(weather_condition).has_state()) return std::string("\U0000e42d");
            std::string c = id(weather_condition).state;
            for (auto &ch : c) ch = tolower(ch);
            if (c.find("snow") != std::string::npos) return std::string("\U0000eb3b");
            if (c.find("clear") != std::string::npos || c.find("sun") != std::string::npos) return std::string("\U0000e430");
            return std::string("\U0000e42d");

      # ===== CLIMATE PAGE UPDATES =====
      - lvgl.label.update:
          id: lbl_c_gar_t
          text: !lambda |-
            if (id(garage_temp).has_state()) return str_sprintf("%.1f°F", id(garage_temp).state);
            return std::string("--.-°F");
      - lvgl.label.update:
          id: lbl_c_gar_h
          text: !lambda |-
            if (id(garage_hum).has_state()) return str_sprintf("%.0f%%", id(garage_hum).state);
            return std::string("--%");
      - lvgl.label.update:
          id: lbl_c_gar_p
          text: !lambda |-
            if (id(garage_pres).has_state()) return str_sprintf("%.0f hPa", id(garage_pres).state);
            return std::string("-- hPa");
      - lvgl.label.update:
          id: lbl_c_gar_iaq
          text: !lambda |-
            if (id(garage_iaq).has_state()) return str_sprintf("%.0f", id(garage_iaq).state);
            return std::string("--");
          text_color: !lambda |-
            if (!id(garage_iaq).has_state()) return lv_color_hex(0x888888);
            float v = id(garage_iaq).state;
            if (v <= 50) return lv_color_hex(0x4ade80);
            if (v <= 100) return lv_color_hex(0xfbbf24);
            if (v <= 150) return lv_color_hex(0xf97316);
            if (v <= 200) return lv_color_hex(0xef4444);
            return lv_color_hex(0xdc2626);
      - lvgl.label.update:
          id: lbl_c_house_t
          text: !lambda |-
            if (id(house_temp).has_state()) return str_sprintf("%.1f°F", id(house_temp).state);
            return std::string("--.-°F");
      - lvgl.label.update:
          id: lbl_c_house_h
          text: !lambda |-
            if (id(house_hum).has_state()) return str_sprintf("%.0f%%", id(house_hum).state);
            return std::string("--%");
      - lvgl.label.update:
          id: lbl_c_house_p
          text: !lambda |-
            if (id(house_pres).has_state()) return str_sprintf("%.0f hPa", id(house_pres).state);
            return std::string("-- hPa");
      - lvgl.label.update:
          id: lbl_c_house_v
          text: !lambda |-
            if (id(house_voc).has_state()) return str_sprintf("%.0f", id(house_voc).state);
            return std::string("--");
          text_color: !lambda |-
            if (!id(house_voc).has_state()) return lv_color_hex(0x888888);
            float v = id(house_voc).state;
            if (v <= 50) return lv_color_hex(0x4ade80);
            if (v <= 100) return lv_color_hex(0xfbbf24);
            if (v <= 150) return lv_color_hex(0xf97316);
            if (v <= 200) return lv_color_hex(0xef4444);
            return lv_color_hex(0xdc2626);

      # ===== STARLINK PAGE UPDATES =====
      - lvgl.label.update:
          id: lbl_s_dl
          text: !lambda |-
            if (id(starlink_dl).has_state()) return str_sprintf("%.1f", id(starlink_dl).state);
            return std::string("--");
      - lvgl.label.update:
          id: lbl_s_ul
          text: !lambda |-
            if (id(starlink_ul).has_state()) return str_sprintf("%.1f", id(starlink_ul).state);
            return std::string("--");
      - lvgl.label.update:
          id: lbl_s_pwr
          text: !lambda |-
            if (id(starlink_pwr).has_state()) return str_sprintf("%.0f W", id(starlink_pwr).state);
            return std::string("-- W");
      - lvgl.label.update:
          id: lbl_s_status
          text: !lambda |-
            if (id(starlink_conn).has_state()) return id(starlink_conn).state ? "Connected" : "Disconnected";
            return std::string("--");
          text_color: !lambda |-
            if (id(starlink_conn).has_state() && id(starlink_conn).state) return lv_color_hex(0x4ade80);
            return lv_color_hex(0xef4444);

      # ===== WEATHER PAGE UPDATES =====
      - lvgl.label.update:
          id: lbl_w_cond
          text: !lambda |-
            if (id(weather_condition).has_state()) return id(weather_condition).state;
            return std::string("Loading...");
      - lvgl.label.update:
          id: lbl_w_icon
          text: !lambda |-
            if (!id(weather_condition).has_state()) return std::string("\U0000e42d");
            std::string c = id(weather_condition).state;
            for (auto &ch : c) ch = tolower(ch);
            if (c.find("snow") != std::string::npos) return std::string("\U0000eb3b");
            if (c.find("clear") != std::string::npos || c.find("sun") != std::string::npos) return std::string("\U0000e430");
            return std::string("\U0000e42d");
      - lvgl.label.update:
          id: lbl_w_temp
          text: !lambda |-
            if (id(weather_temp).has_state()) return str_sprintf("%.0f°F", id(weather_temp).state);
            return std::string("--°F");
      - lvgl.label.update:
          id: lbl_w_hum
          text: !lambda |-
            if (id(weather_humidity).has_state()) return str_sprintf("%.0f%%", id(weather_humidity).state);
            return std::string("--%");
      - lvgl.label.update:
          id: lbl_w_wind
          text: !lambda |-
            if (id(weather_wind).has_state()) return str_sprintf("%.1f mph", id(weather_wind).state);
            return std::string("--");

      # ===== PROFESSIONAL SENSORS PAGE UPDATES (v27) =====
      
      # Battery status with CHARGING indicator
      - lvgl.label.update:
          id: lbl_s_battery
          text: !lambda |-
            if (id(battery_pct).has_state()) return str_sprintf("%.0f%%", id(battery_pct).state);
            return std::string("---%");
      - lvgl.label.update:
          id: lbl_s_batt_status
          text: !lambda |-
            if (id(batt_charging).state) return std::string("CHARGING");
            if (id(battery_pct).has_state() && id(battery_pct).state < 20) return std::string("LOW");
            return std::string("READY");
          text_color: !lambda |-
            if (id(batt_charging).state) return lv_color_hex(0xfbbf24);  // Yellow when charging
            if (id(battery_pct).has_state() && id(battery_pct).state < 20) return lv_color_hex(0xff6b6b);  // Red when low
            return lv_color_hex(0x4ade80);  // Green when ready
      - lvgl.label.update:
          id: lbl_s_batt_icon
          text: !lambda |-
            if (id(batt_charging).state) return std::string("\U0000e1be");  // charging icon
            if (id(battery_pct).has_state() && id(battery_pct).state < 20) return std::string("\U0000e19c");  // alert icon
            return std::string("\U0000e1a3");  // full icon

      # Overall AQI
      - lvgl.label.update:
          id: lbl_s_aqi
          text: !lambda |-
            if (id(garage_iaq).has_state()) return str_sprintf("%.0f", id(garage_iaq).state);
            return std::string("---");
      - lvgl.label.update:
          id: lbl_s_aqi_status
          text: !lambda |-
            if (id(aqi_status).has_state()) return id(aqi_status).state;
            return std::string("Unknown");
          text_color: !lambda |-
            if (!id(garage_iaq).has_state()) return lv_color_hex(0x888888);
            float aqi = id(garage_iaq).state;
            if (aqi <= 150) return lv_color_hex(0x4ade80);   // Green
            if (aqi <= 300) return lv_color_hex(0xfbbf24);   // Yellow
            if (aqi <= 400) return lv_color_hex(0xf97316);   // Orange
            return lv_color_hex(0xef4444);  // Red

      # Temperature & Humidity
      - lvgl.label.update:
          id: lbl_s_temp
          text: !lambda |-
            if (id(scd41_temp_f).has_state()) return str_sprintf("%.1f°F", id(scd41_temp_f).state);
            return std::string("--°F");
      - lvgl.label.update:
          id: lbl_s_humidity
          text: !lambda |-
            if (id(scd41_hum).has_state()) return str_sprintf("%.0f%%", id(scd41_hum).state);
            return std::string("--%");

      # CO2 with Arc Meter
      - lvgl.label.update:
          id: lbl_s_co2_value
          text: !lambda |-
            if (id(scd41_co2).has_state()) return str_sprintf("%.0f", id(scd41_co2).state);
            return std::string("---");
      - lvgl.arc.update:
          id: arc_co2
          value: !lambda |-
            if (id(scd41_co2).has_state()) return (int)id(scd41_co2).state;
            return 400;
          indicator:
            arc_color: !lambda |-
              if (!id(scd41_co2).has_state()) return lv_color_hex(0x888888);
              float co2 = id(scd41_co2).state;
              if (co2 < 1200) return lv_color_hex(0x4ade80);   // Green
              if (co2 < 1800) return lv_color_hex(0xfbbf24);   // Yellow
              if (co2 < 2500) return lv_color_hex(0xf97316);   // Orange
              return lv_color_hex(0xef4444);  // Red
      - lvgl.label.update:
          id: lbl_s_co2_status
          text: !lambda |-
            if (!id(scd41_co2).has_state()) return std::string("Unknown");
            float co2 = id(scd41_co2).state;
            if (co2 < 1200) return std::string("Excellent");
            if (co2 < 1800) return std::string("Good");
            if (co2 < 2500) return std::string("Moderate");
            return std::string("Poor");
          text_color: !lambda |-
            if (!id(scd41_co2).has_state()) return lv_color_hex(0x888888);
            float co2 = id(scd41_co2).state;
            if (co2 < 1200) return lv_color_hex(0x4ade80);
            if (co2 < 1800) return lv_color_hex(0xfbbf24);
            if (co2 < 2500) return lv_color_hex(0xf97316);
            return lv_color_hex(0xef4444);

      # ⭐ BME680 DISPLAYS (WERE MISSING - NOW ADDED!)
      - lvgl.label.update:
          id: lbl_s_bme680_iaq
          text: !lambda |-
            if (id(bme680_iaq).has_state()) return str_sprintf("%.0f", id(bme680_iaq).state);
            return std::string("--");
          text_color: !lambda |-
            if (!id(bme680_iaq).has_state()) return lv_color_hex(0x888888);
            float iaq = id(bme680_iaq).state;
            if (iaq <= 150) return lv_color_hex(0x4ade80);   // Green
            if (iaq <= 300) return lv_color_hex(0xfbbf24);   // Yellow
            if (iaq <= 400) return lv_color_hex(0xf97316);   // Orange
            return lv_color_hex(0xef4444);  // Red

      - lvgl.label.update:
          id: lbl_s_bme680_voc
          text: !lambda |-
            if (id(bme680_voc).has_state()) return str_sprintf("%.1f ppm", id(bme680_voc).state);
            return std::string("-- ppm");
          text_color: !lambda |-
            if (!id(bme680_voc).has_state()) return lv_color_hex(0x888888);
            float voc = id(bme680_voc).state;
            if (voc < 5.0) return lv_color_hex(0x4ade80);   // Green
            if (voc < 10.0) return lv_color_hex(0xfbbf24);  // Yellow
            return lv_color_hex(0xef4444);  // Red

      - lvgl.label.update:
          id: lbl_s_bme680_gas
          text: !lambda |-
            if (id(bme680_gas).has_state()) {
              float r = id(bme680_gas).state / 1000.0f;
              return str_sprintf("%.0f kOhm", r);
            }
            return std::string("-- kOhm");

      # Gas Bars with Dynamic Color Coding
      - lvgl.bar.update:
          id: bar_s_co
          value: !lambda |-
            if (id(gas_co_ppm).has_state()) {
              float ppm = id(gas_co_ppm).state;
              if (ppm > 200) ppm = 200;
              return (int)ppm;
            }
            return 0;
          indicator:
            bg_color: !lambda |-
              if (!id(gas_co_ppm).has_state()) return lv_color_hex(0x888888);
              float ppm = id(gas_co_ppm).state;
              if (ppm < 50) return lv_color_hex(0x4ade80);
              if (ppm < 200) return lv_color_hex(0xfbbf24);
              return lv_color_hex(0xef4444);

      - lvgl.label.update:
          id: lbl_s_co_ppm
          text: !lambda |-
            if (id(gas_co_ppm).has_state()) return str_sprintf("%.0f ppm", id(gas_co_ppm).state);
            return std::string("-- ppm");
          text_color: !lambda |-
            if (!id(gas_co_ppm).has_state()) return lv_color_hex(0x888888);
            float ppm = id(gas_co_ppm).state;
            if (ppm < 50) return lv_color_hex(0x4ade80);
            if (ppm < 200) return lv_color_hex(0xfbbf24);
            return lv_color_hex(0xef4444);

      - lvgl.label.update:
          id: lbl_s_co_volts
          text: !lambda |-
            if (id(mics_co_v).has_state()) return str_sprintf("%.0f mV", id(mics_co_v).state * 1000.0f);
            return std::string("-- mV");

      - lvgl.bar.update:
          id: bar_s_nh3
          value: !lambda |-
            if (id(gas_nh3_ppm).has_state()) return (int)id(gas_nh3_ppm).state;
            return 0;

      - lvgl.label.update:
          id: lbl_s_nh3_ppm
          text: !lambda |-
            if (id(gas_nh3_ppm).has_state()) return str_sprintf("%.0f ppm", id(gas_nh3_ppm).state);
            return std::string("-- ppm");

      - lvgl.label.update:
          id: lbl_s_nh3_volts
          text: !lambda |-
            if (id(mics_nh3_v).has_state()) return str_sprintf("%.0f mV", id(mics_nh3_v).state * 1000.0f);
            return std::string("-- mV");

      - lvgl.bar.update:
          id: bar_s_no2
          value: !lambda |-
            if (id(gas_no2_ppm).has_state()) return (int)(id(gas_no2_ppm).state * 10);
            return 0;

      - lvgl.label.update:
          id: lbl_s_no2_ppm
          text: !lambda |-
            if (id(gas_no2_ppm).has_state()) return str_sprintf("%.1f ppm", id(gas_no2_ppm).state);
            return std::string("-- ppm");

      - lvgl.label.update:
          id: lbl_s_no2_volts
          text: !lambda |-
            if (id(mics_no2_v).has_state()) return str_sprintf("%.0f mV", id(mics_no2_v).state * 1000.0f);
            return std::string("-- mV");

      # ===== SETTINGS PAGE UPDATES =====
      - lvgl.label.update:
          id: lbl_set_ip
          text: !lambda |-
            if (id(wifi_ip).has_state()) return "IP: " + id(wifi_ip).state;
            return std::string("IP: --");
      - lvgl.label.update:
          id: lbl_set_wifi
          text: !lambda |-
            if (id(wifi_rssi).has_state()) return str_sprintf("WiFi: %.0f dBm", id(wifi_rssi).state);
            return std::string("WiFi: --");
      - lvgl.label.update:
          id: lbl_set_wifi2
          text: !lambda |-
            if (id(wifi_pct).has_state()) return str_sprintf("WiFi: %.0f%%", id(wifi_pct).state);
            return std::string("WiFi: --");
      - lvgl.label.update:
          id: lbl_set_up
          text: !lambda |-
            if (id(uptime_sec).has_state()) {
              int s = (int)id(uptime_sec).state;
              int m = s / 60; int h = m / 60; int d = h / 24;
              if (d > 0) return str_sprintf("Uptime: %dd %dh", d, h % 24);
              if (h > 0) return str_sprintf("Uptime: %dh %dm", h, m % 60);
              return str_sprintf("Uptime: %dm %ds", m, s % 60);
            }
            return std::string("Uptime: --");

      # ===== RAW PAGE UPDATES =====
      # MiCS-6814 Gas Voltages
      - lvgl.label.update:
          id: lbl_raw_co_v
          text: !lambda |-
            if (id(mics_co_v).has_state()) return str_sprintf("%.0f mV", id(mics_co_v).state * 1000.0f);
            return std::string("-- mV");
      - lvgl.label.update:
          id: lbl_raw_nh3_v
          text: !lambda |-
            if (id(mics_nh3_v).has_state()) return str_sprintf("%.0f mV", id(mics_nh3_v).state * 1000.0f);
            return std::string("-- mV");
      - lvgl.label.update:
          id: lbl_raw_no2_v
          text: !lambda |-
            if (id(mics_no2_v).has_state()) return str_sprintf("%.0f mV", id(mics_no2_v).state * 1000.0f);
            return std::string("-- mV");
      - lvgl.label.update:
          id: lbl_raw_baseline
          text: !lambda |-
            if (id(g_baseline_valid)) return std::string("Valid");
            return std::string("Not Set");
      - lvgl.label.update:
          id: lbl_raw_co_ratio
          text: !lambda |-
            if (id(mics_co_ratio).has_state()) return str_sprintf("%.2f", id(mics_co_ratio).state);
            return std::string("--");
      # BME680 Raw Data
      - lvgl.label.update:
          id: lbl_raw_bme_gas
          text: !lambda |-
            if (id(bme680_gas).has_state()) return str_sprintf("%.0f kOhm", id(bme680_gas).state / 1000.0f);
            return std::string("-- kOhm");
      - lvgl.label.update:
          id: lbl_raw_bme_iaq
          text: !lambda |-
            if (id(bme680_iaq).has_state()) return str_sprintf("%.0f", id(bme680_iaq).state);
            return std::string("--");
      - lvgl.label.update:
          id: lbl_raw_bme_iaq_acc
          text: !lambda |-
            if (id(bme680_iaq_accuracy).has_state()) {
              int acc = (int)id(bme680_iaq_accuracy).state;
              if (acc == 0) return std::string("0 (Learning)");
              if (acc == 1) return std::string("1 (Calibrating)");
              if (acc == 2) return std::string("2 (Stable)");
              if (acc == 3) return std::string("3 (Accurate)");
              return str_sprintf("%d", acc);
            }
            return std::string("--");
      - lvgl.label.update:
          id: lbl_raw_bme_temp
          text: !lambda |-
            if (id(bme680_temp).has_state()) {
              float f = id(bme680_temp).state * 9.0f/5.0f + 32.0f;
              return str_sprintf("%.1f°F", f);
            }
            return std::string("--");
      - lvgl.label.update:
          id: lbl_raw_bme_press
          text: !lambda |-
            if (id(bme680_press).has_state()) {
              float inhg = id(bme680_press).state * 0.02953f;
              return str_sprintf("%.2f inHg", inhg);
            }
            return std::string("--");
      # SCD41 Raw Data
      - lvgl.label.update:
          id: lbl_raw_scd_co2
          text: !lambda |-
            if (id(scd41_co2).has_state()) return str_sprintf("%.0f ppm", id(scd41_co2).state);
            return std::string("-- ppm");
      - lvgl.label.update:
          id: lbl_raw_scd_temp
          text: !lambda |-
            if (id(scd41_temp_c).has_state()) {
              float f = id(scd41_temp_c).state * 9.0f/5.0f + 32.0f;
              return str_sprintf("%.1f°F", f);
            }
            return std::string("--");
      - lvgl.label.update:
          id: lbl_raw_scd_hum
          text: !lambda |-
            if (id(scd41_hum).has_state()) return str_sprintf("%.0f%%", id(scd41_hum).state);
            return std::string("--%");
      # Battery ADC Raw Data
      - lvgl.label.update:
          id: lbl_raw_batt_adc
          text: !lambda |-
            if (id(batt_adc_v).has_state()) return str_sprintf("%.2f V", id(batt_adc_v).state);
            return std::string("-- V");
      - lvgl.label.update:
          id: lbl_raw_batt_v
          text: !lambda |-
            if (id(battery_voltage).has_state()) return str_sprintf("%.2f V", id(battery_voltage).state);
            return std::string("-- V");
      - lvgl.label.update:
          id: lbl_raw_batt_pct
          text: !lambda |-
            if (id(battery_pct).has_state()) return str_sprintf("%.0f%%", id(battery_pct).state);
            return std::string("--%");

  # ========== SCREEN SAVER ANIMATION ==========
  # Updates screen saver text position at 50ms intervals (20 FPS)
  # Text bounces around display staying 100% within bounds
  # Only runs when screen saver is active
  
  - interval: 50ms
    then:
      - lambda: |-
          if (!id(screensaver_active)) return;  // Skip if not in screen saver mode
          
          // Text dimensions (approximate bounding box)
          const int text_width = 320;   // "TotalSense by Jeremy Boven" width
          const int text_height = 80;   // Two lines of text height
          const int screen_width = 800;
          const int screen_height = 480;
          
          // Update position based on velocity
          id(saver_x) += id(saver_dx);
          id(saver_y) += id(saver_dy);
          
          // Bounce off edges (100% contained within display bounds)
          if (id(saver_x) <= 0 || id(saver_x) >= screen_width - text_width) {
            id(saver_dx) = -id(saver_dx);  // Reverse horizontal direction
            // Clamp to valid range to prevent escape
            id(saver_x) = (id(saver_x) <= 0) ? 0 : screen_width - text_width;
          }
          if (id(saver_y) <= 0 || id(saver_y) >= screen_height - text_height) {
            id(saver_dy) = -id(saver_dy);  // Reverse vertical direction
            // Clamp to valid range to prevent escape
            id(saver_y) = (id(saver_y) <= 0) ? 0 : screen_height - text_height;
          }
      - lvgl.widget.update:
          id: lbl_screensaver
          x: !lambda 'return id(saver_x);'
          y: !lambda 'return id(saver_y);'
