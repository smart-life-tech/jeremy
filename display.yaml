substitutions:
  plug1_ip: "192.168.68.79"
  plug2_ip: "192.168.68.77"
  plug3_ip: "192.168.68.76"
  plug4_ip: "192.168.68.75"
  plug5_ip: "192.168.68.203"
  plug6_ip: "192.168.68.204"
  plug7_ip: "192.168.68.205"
  plug8_ip: "192.168.68.206"

esphome:
  name: waveshare-esp32-s3-7in
  friendly_name: Waveshare ESP32-S3 7in
  min_version: "2025.4.2"
  platformio_options:
    build_flags: "-DBOARD_HAS_PSRAM"
    board_build.arduino.memory_type: qio_opi
    board_build.flash_mode: dio
    board_upload.maximum_ram_size: 524288

psram:
  mode: octal
  speed: 120MHz

esp32:
  board: esp32-s3-devkitc-1
  variant: ESP32S3
  flash_size: 8MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: true
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESPTOOLPY_FLASHSIZE_8MB: "y"
      CONFIG_FREERTOS_HZ: "1000"
      CONFIG_ESP_DEFAULT_CPU_FREQ_MHZ_240: y
      CONFIG_ESPTOOLPY_FLASHMODE_QIO: y
      CONFIG_ESPTOOLPY_FLASHFREQ_120M: y
      CONFIG_SPIRAM_MODE_OCT: y
      CONFIG_IDF_EXPERIMENTAL_FEATURES: y
      CONFIG_SPIRAM_SPEED_120M: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: y
      CONFIG_COMPILER_OPTIMIZATION_PERF: y

logger:
  level: WARN

wifi:
  ssid: "JEREMY"
  password: "605506Jdb"
  power_save_mode: NONE
  reboot_timeout: 0s   # prevent auto reboot on Wi-Fi idle

  ap:
    ssid: "WaveshareS3-7in Fallback"
    password: "12345678"

captive_portal:

api:
  reboot_timeout: 0s   # prevent auto reboot on API idle
  encryption:
    key: "+6lkh+FkWq3HVFh6+NukfmN188wGMQap7sw2RK1p9Gg="

ota:
  # DO NOT REMOVE
  - platform: esphome
    password: "48170f28ed94e6fe392d67906b01ff74"

http_request:
  id: http_client
  timeout: 300ms

i2c:
  sda: GPIO08
  scl: GPIO09
  scan: true
  id: bus_a

ch422g:
  - id: ch422g_hub

output:
  - platform: ledc
    id: lcdbacklight_output
    pin: GPIO16
    frequency: 1000 Hz

light:
  - platform: monochromatic
    id: lcdbacklight
    name: LCD Backlight
    output: lcdbacklight_output
    icon: mdi:wall-sconce-flat-outline
    disabled_by_default: true
    restore_mode: ALWAYS_ON

globals:
  - id: last_activity
    type: uint32_t
    restore_value: no
    initial_value: "0"

  # 0=AUTO (5m), 1=ON
  - id: bl_mode
    type: int
    restore_value: yes
    initial_value: "0"

  - id: bl_level
    type: int
    restore_value: yes
    initial_value: "100"

  - id: plug1_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug2_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug3_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug4_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug5_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug6_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug7_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug8_ui_state
    type: bool
    restore_value: no
    initial_value: "false"

  # IP Address Storage (persisted across boots)
  - id: plug1_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"192.168.68.79"'

  - id: plug2_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"192.168.68.77"'

  - id: plug3_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"192.168.68.76"'

  - id: plug4_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"192.168.68.75"'

  - id: plug5_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"192.168.68.203"'

  - id: plug6_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"192.168.68.204"'

  - id: plug7_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"192.168.68.205"'

  - id: plug8_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"192.168.68.206"'

  # Persisted timer values & schedule enabled flags (survive power loss)
  - id: plug1_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug1_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug1_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug1_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug1_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug1_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug1_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # Repeat for plugs 2..8 (only listing fields changed below)
  - id: plug2_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug2_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug2_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug2_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug2_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug2_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug2_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug3_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug3_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug3_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug3_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug3_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug3_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug3_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug4_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug4_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug4_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug4_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug4_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug4_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug4_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug5_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug5_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug5_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug5_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug5_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug5_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug5_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug6_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug6_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug6_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug6_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug6_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug6_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug6_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug7_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug7_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug7_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug7_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug7_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug7_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug7_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug8_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug8_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug8_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug8_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug8_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug8_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug8_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # ================================
switch:
  # CH422G backlight power
  - platform: gpio
    id: lcd_backlight_sw
    internal: true
    pin:
      ch422g: ch422g_hub
      number: 2
      mode:
        output: true
      inverted: false
    restore_mode: ALWAYS_ON

  # Schedule switches
  - platform: template
    id: plug1_schedule_enabled
    name: "Plug 1 Schedule Enabled"
    optimistic: true
    entity_category: "config"
  - platform: template
    id: plug2_schedule_enabled
    name: "Plug 2 Schedule Enabled"
    optimistic: true
    entity_category: "config"
  - platform: template
    id: plug3_schedule_enabled
    name: "Plug 3 Schedule Enabled"
    optimistic: true
    entity_category: "config"
  - platform: template
    id: plug4_schedule_enabled
    name: "Plug 4 Schedule Enabled"
    optimistic: true
    entity_category: "config"
  - platform: template
    id: plug5_schedule_enabled
    name: "Plug 5 Schedule Enabled"
    optimistic: true
    entity_category: "config"
  - platform: template
    id: plug6_schedule_enabled
    name: "Plug 6 Schedule Enabled"
    optimistic: true
    entity_category: "config"
  - platform: template
    id: plug7_schedule_enabled
    name: "Plug 7 Schedule Enabled"
    optimistic: true
    entity_category: "config"
  - platform: template
    id: plug8_schedule_enabled
    name: "Plug 8 Schedule Enabled"
    optimistic: true
    entity_category: "config"

script:
  - id: register_activity
    then:
      - lambda: |-
          id(last_activity) = millis();
          id(lcd_backlight_sw).turn_on();
          if (id(bl_mode) == 0) {
            auto call = id(lcdbacklight).turn_on();
            float bri = id(bl_level) / 100.0f;
            call.set_brightness(bri);
            call.perform();
          }

  - id: bl_auto_off_check
    then:
      - lambda: |-
          uint32_t now = millis();
          if (id(last_activity) == 0) {
            id(last_activity) = now;
            return;
          }
          uint32_t timeout_ms = 5UL * 60UL * 1000UL;
          if (id(bl_mode) == 0) {
            if (now - id(last_activity) > timeout_ms) {
              ESP_LOGI("backlight", "Auto-off: turning backlight OFF after 5 min inactivity");
              auto call = id(lcdbacklight).turn_off();
              call.perform();
              id(lcd_backlight_sw).turn_off();
              id(last_activity) = now;
            }
          }

  # per-plug schedule helpers (turn_on/off + update_state)
  - id: plug1_turn_on
    then:
      - logger.log: "Schedule: turning Plug 1 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug1_update_state

  - id: plug1_turn_off
    then:
      - logger.log: "Schedule: turning Plug 1 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug1_update_state

  - id: plug2_turn_on
    then:
      - logger.log: "Schedule: turning Plug 2 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug2_update_state

  - id: plug2_turn_off
    then:
      - logger.log: "Schedule: turning Plug 2 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug2_update_state

  - id: plug3_turn_on
    then:
      - logger.log: "Schedule: turning Plug 3 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug3_update_state

  - id: plug3_turn_off
    then:
      - logger.log: "Schedule: turning Plug 3 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug3_update_state

  - id: plug4_turn_on
    then:
      - logger.log: "Schedule: turning Plug 4 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug4_update_state

  - id: plug4_turn_off
    then:
      - logger.log: "Schedule: turning Plug 4 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug4_update_state

  - id: plug5_turn_on
    then:
      - logger.log: "Schedule: turning Plug 5 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug5_update_state

  - id: plug5_turn_off
    then:
      - logger.log: "Schedule: turning Plug 5 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug5_update_state

  - id: plug6_turn_on
    then:
      - logger.log: "Schedule: turning Plug 6 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug6_update_state

  - id: plug6_turn_off
    then:
      - logger.log: "Schedule: turning Plug 6 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug6_update_state

  - id: plug7_turn_on
    then:
      - logger.log: "Schedule: turning Plug 7 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug7_update_state

  - id: plug7_turn_off
    then:
      - logger.log: "Schedule: turning Plug 7 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug7_update_state

  
  # ==========================================
  # Kauf PLF12 plug state helpers
  - id: plug1_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug1_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug1), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug1_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug1), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug2_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug2_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug2), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug2_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug2), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug3_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug3_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug3), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug3_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug3), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug4_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug4_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug4), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug4_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug4), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug5_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug5_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug5), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug5_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug5), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug6_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug6_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug6), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug6_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug6), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug7_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug7_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug7), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug7_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug7), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: toggle_plug8_device
    then:
      - logger.log: "Manual: toggling Plug 8"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug/toggle");
      - delay: 500ms
      - script.execute: plug8_update_state

  - id: plug8_turn_on
    then:
      - logger.log: "Schedule: turning Plug 8 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug8_update_state

  - id: plug8_turn_off
    then:
      - logger.log: "Schedule: turning Plug 8 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug8_update_state

  - id: plug8_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug8_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug8), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug8_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug8), lv_color_hex(0xFF0000), LV_PART_MAIN);

  # Fetch basic info (raw body) from all plugs and populate labels on the Plug Info page
  - id: fetch_all_plug_info
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  auto extract = [&](const std::string &k)->std::string {
                    size_t p = body.find(k);
                    if (p == std::string::npos) return std::string("");
                    size_t colon = body.find(':', p);
                    if (colon == std::string::npos) return std::string("");
                    size_t s = colon + 1;
                    while (s < body.size() && (body[s] == ' ' || body[s] == '"')) s++;
                    size_t e = s;
                    while (e < body.size() && ((body[e] >= '0' && body[e] <= '9') || body[e] == '.' || body[e] == '-')) e++;
                    return body.substr(s, e - s);
                  };
                  std::string st = extract("\"state\"");
                  std::string pw = extract("\"power\"");
                  std::string cu = extract("\"current\"");
                  std::string vo = extract("\"voltage\"");
                  std::string out = "S:" + (st.empty()? std::string("?") : st);
                  lv_label_set_text(id(lbl_plug4_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug4_info), "unreachable");
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/sensor/kauf_plug_current");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug4_info));
                  std::string out = std::string(old ? old : "") + "  I:" + val + "A";
                  lv_label_set_text(id(lbl_plug4_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug4_info));
                  std::string out = std::string(old ? old : "") + "  I:-A";
                  lv_label_set_text(id(lbl_plug4_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/sensor/kauf_plug_voltage");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug4_info));
                  std::string out = std::string(old ? old : "") + "  V:" + val + "V";
                  lv_label_set_text(id(lbl_plug4_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug4_info));
                  std::string out = std::string(old ? old : "") + "  V:-V";
                  lv_label_set_text(id(lbl_plug4_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  auto extract = [&](const std::string &k)->std::string {
                    size_t p = body.find(k);
                    if (p == std::string::npos) return std::string("");
                    size_t colon = body.find(':', p);
                    if (colon == std::string::npos) return std::string("");
                    size_t s = colon + 1;
                    while (s < body.size() && (body[s] == ' ' || body[s] == '"')) s++;
                    size_t e = s;
                    while (e < body.size() && ((body[e] >= '0' && body[e] <= '9') || body[e] == '.' || body[e] == '-')) e++;
                    return body.substr(s, e - s);
                  };
                  std::string st = extract("\"state\"");
                  std::string pw = extract("\"power\"");
                  std::string cu = extract("\"current\"");
                  std::string vo = extract("\"voltage\"");
                  std::string out = "S:" + (st.empty()? std::string("?") : st);
                  lv_label_set_text(id(lbl_plug2_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug2_info), "unreachable");
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/sensor/kauf_plug_current");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug2_info));
                  std::string out = std::string(old ? old : "") + "  I:" + val + "A";
                  lv_label_set_text(id(lbl_plug2_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug2_info));
                  std::string out = std::string(old ? old : "") + "  I:-A";
                  lv_label_set_text(id(lbl_plug2_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/sensor/kauf_plug_voltage");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug2_info));
                  std::string out = std::string(old ? old : "") + "  V:" + val + "V";
                  lv_label_set_text(id(lbl_plug2_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug2_info));
                  std::string out = std::string(old ? old : "") + "  V:-V";
                  lv_label_set_text(id(lbl_plug2_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  auto extract = [&](const std::string &k)->std::string {
                    size_t p = body.find(k);
                    if (p == std::string::npos) return std::string("");
                    size_t colon = body.find(':', p);
                    if (colon == std::string::npos) return std::string("");
                    size_t s = colon + 1;
                    while (s < body.size() && (body[s] == ' ' || body[s] == '"')) s++;
                    size_t e = s;
                    while (e < body.size() && ((body[e] >= '0' && body[e] <= '9') || body[e] == '.' || body[e] == '-')) e++;
                    return body.substr(s, e - s);
                  };
                  std::string st = extract("\"state\"");
                  std::string pw = extract("\"power\"");
                  std::string cu = extract("\"current\"");
                  std::string vo = extract("\"voltage\"");
                  std::string out = "S:" + (st.empty()? std::string("?") : st);
                  lv_label_set_text(id(lbl_plug3_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug3_info), "unreachable");
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/sensor/kauf_plug_current");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug3_info));
                  std::string out = std::string(old ? old : "") + "  I:" + val + "A";
                  lv_label_set_text(id(lbl_plug3_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug3_info));
                  std::string out = std::string(old ? old : "") + "  I:-A";
                  lv_label_set_text(id(lbl_plug3_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/sensor/kauf_plug_voltage");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug3_info));
                  std::string out = std::string(old ? old : "") + "  V:" + val + "V";
                  lv_label_set_text(id(lbl_plug3_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug3_info));
                  std::string out = std::string(old ? old : "") + "  V:-V";
                  lv_label_set_text(id(lbl_plug3_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  auto extract = [&](const std::string &k)->std::string {
                    size_t p = body.find(k);
                    if (p == std::string::npos) return std::string("");
                    size_t colon = body.find(':', p);
                    if (colon == std::string::npos) return std::string("");
                    size_t s = colon + 1;
                    while (s < body.size() && (body[s] == ' ' || body[s] == '"')) s++;
                    size_t e = s;
                    while (e < body.size() && ((body[e] >= '0' && body[e] <= '9') || body[e] == '.' || body[e] == '-')) e++;
                    return body.substr(s, e - s);
                  };
                  std::string st = extract("\"state\"");
                  std::string pw = extract("\"power\"");
                  std::string cu = extract("\"current\"");
                  std::string vo = extract("\"voltage\"");
                  std::string out = "S:" + (st.empty()? std::string("?") : st);
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug1_info), "unreachable");
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/sensor/kauf_plug_current");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug1_info));
                  std::string out = std::string(old ? old : "") + "  I:" + val + "A";
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug1_info));
                  std::string out = std::string(old ? old : "") + "  I:-A";
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/sensor/kauf_plug_voltage");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug1_info));
                  std::string out = std::string(old ? old : "") + "  V:" + val + "V";
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug1_info));
                  std::string out = std::string(old ? old : "") + "  V:-V";
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug5_info), body.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug5_info), "unreachable");
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug6_info), body.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug6_info), "unreachable");
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug7_info), body.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug7_info), "unreachable");
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug8_info), body.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug8_info), "unreachable");


font:
  - file: "gfonts://Roboto"
    id: font_large
    size: 26
  - file: "gfonts://Roboto"
    id: font_small
    size: 18

time:
  - platform: sntp
    id: sntp_time

number:
  # Plug 1
  - platform: template
    id: plug1_on_hour
    name: "Plug 1 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 8
    entity_category: "config"
  - platform: template
    id: plug1_on_minute
    name: "Plug 1 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"
  - platform: template
    id: plug1_off_hour
    name: "Plug 1 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 6
    entity_category: "config"
  - platform: template
    id: plug1_off_minute
    name: "Plug 1 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"

  # Plug 2
  - platform: template
    id: plug2_on_hour
    name: "Plug 2 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 8
    entity_category: "config"
  - platform: template
    id: plug2_on_minute
    name: "Plug 2 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"
  - platform: template
    id: plug2_off_hour
    name: "Plug 2 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 6
    entity_category: "config"
  - platform: template
    id: plug2_off_minute
    name: "Plug 2 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"

  # Plug 3
  - platform: template
    id: plug3_on_hour
    name: "Plug 3 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 8
    entity_category: "config"
  - platform: template
    id: plug3_on_minute
    name: "Plug 3 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"
  - platform: template
    id: plug3_off_hour
    name: "Plug 3 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 6
    entity_category: "config"
  - platform: template
    id: plug3_off_minute
    name: "Plug 3 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"

  # Plug 4
  - platform: template
    id: plug4_on_hour
    name: "Plug 4 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 8
    entity_category: "config"
  - platform: template
    id: plug4_on_minute
    name: "Plug 4 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"
  - platform: template
    id: plug4_off_hour
    name: "Plug 4 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 6
    entity_category: "config"
  - platform: template
    id: plug4_off_minute
    name: "Plug 4 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"

  # Plug 5
  - platform: template
    id: plug5_on_hour
    name: "Plug 5 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 8
    entity_category: "config"
  - platform: template
    id: plug5_on_minute
    name: "Plug 5 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"
  - platform: template
    id: plug5_off_hour
    name: "Plug 5 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 6
    entity_category: "config"
  - platform: template
    id: plug5_off_minute
    name: "Plug 5 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"

  # Plug 6
  - platform: template
    id: plug6_on_hour
    name: "Plug 6 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 8
    entity_category: "config"
  - platform: template
    id: plug6_on_minute
    name: "Plug 6 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"
  - platform: template
    id: plug6_off_hour
    name: "Plug 6 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 6
    entity_category: "config"
  - platform: template
    id: plug6_off_minute
    name: "Plug 6 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"

  # Plug 7
  - platform: template
    id: plug7_on_hour
    name: "Plug 7 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 8
    entity_category: "config"
  - platform: template
    id: plug7_on_minute
    name: "Plug 7 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"
  - platform: template
    id: plug7_off_hour
    name: "Plug 7 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 6
    entity_category: "config"
  - platform: template
    id: plug7_off_minute
    name: "Plug 7 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"

  # Plug 8
  - platform: template
    id: plug8_on_hour
    name: "Plug 8 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 8
    entity_category: "config"
  - platform: template
    id: plug8_on_minute
    name: "Plug 8 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"
  - platform: template
    id: plug8_off_hour
    name: "Plug 8 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    initial_value: 6
    entity_category: "config"
  - platform: template
    id: plug8_off_minute
    name: "Plug 8 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    initial_value: 0
    entity_category: "config"

select:
  # Plug 1
  - platform: template
    id: plug1_on_ampm
    name: "Plug 1 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "AM"
    entity_category: "config"
  - platform: template
    id: plug1_off_ampm
    name: "Plug 1 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "PM"
    entity_category: "config"

  # Plug 2
  - platform: template
    id: plug2_on_ampm
    name: "Plug 2 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "AM"
    entity_category: "config"
  - platform: template
    id: plug2_off_ampm
    name: "Plug 2 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "PM"
    entity_category: "config"

  # Plug 3
  - platform: template
    id: plug3_on_ampm
    name: "Plug 3 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "AM"
    entity_category: "config"
  - platform: template
    id: plug3_off_ampm
    name: "Plug 3 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "PM"
    entity_category: "config"

  # Plug 4
  - platform: template
    id: plug4_on_ampm
    name: "Plug 4 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "AM"
    entity_category: "config"
  - platform: template
    id: plug4_off_ampm
    name: "Plug 4 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "PM"
    entity_category: "config"

  # Plug 5
  - platform: template
    id: plug5_on_ampm
    name: "Plug 5 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "AM"
    entity_category: "config"
  - platform: template
    id: plug5_off_ampm
    name: "Plug 5 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "PM"
    entity_category: "config"

  # Plug 6
  - platform: template
    id: plug6_on_ampm
    name: "Plug 6 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "AM"
    entity_category: "config"
  - platform: template
    id: plug6_off_ampm
    name: "Plug 6 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "PM"
    entity_category: "config"

  # Plug 7
  - platform: template
    id: plug7_on_ampm
    name: "Plug 7 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "AM"
    entity_category: "config"
  - platform: template
    id: plug7_off_ampm
    name: "Plug 7 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "PM"
    entity_category: "config"

  # Plug 8
  - platform: template
    id: plug8_on_ampm
    name: "Plug 8 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "AM"
    entity_category: "config"
  - platform: template
    id: plug8_off_ampm
    name: "Plug 8 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    initial_option: "PM"
    entity_category: "config"

display:
  - platform: rpi_dpi_rgb
    id: waveshare_display
    auto_clear_enabled: false
    color_order: RGB
    pclk_frequency: 16MHz
    dimensions:
      width: 800
      height: 480
    de_pin:
      number: 5
    hsync_pin:
      number: 46
      ignore_strapping_warning: true
    vsync_pin:
      number: 3
      ignore_strapping_warning: true
    pclk_pin:
      number: 7
    pclk_inverted: true
    reset_pin:
      ch422g: ch422g_hub
      number: 3
    hsync_back_porch: 8
    hsync_front_porch: 8
    hsync_pulse_width: 4
    vsync_back_porch: 16
    vsync_front_porch: 16
    vsync_pulse_width: 4
    data_pins:
      red:   [1, 2, 42, 41, 40]
      blue:  [14, 38, 18, 17, 10]
      green: [39, 0, 45, 48, 47, 21]

touchscreen:
  - platform: gt911
    id: waveshare_touch
    interrupt_pin: GPIO4
    reset_pin:
      ch422g: ch422g_hub
      number: 1
      mode: OUTPUT

lvgl:
  log_level: INFO
  color_depth: 16
  bg_color: 0x101830

  displays:
    - waveshare_display
  touchscreens:
    - waveshare_touch

  on_ready:
    then:
      - lvgl.page.show:
          id: main_page
      - script.execute: register_activity
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          char buf[16];
          int h12 = now.hour % 12;
          if (h12 == 0) h12 = 12;
          bool pm = now.hour >= 12;
          sprintf(buf, "%02d:%02d %s", h12, now.minute, pm ? "PM" : "AM");
          lv_label_set_text(id(lbl_main_time), buf);
          lv_label_set_text(id(lbl_timer1_clock), buf);
          lv_label_set_text(id(lbl_timer2_clock), buf);
          lv_label_set_text(id(lbl_timer3_clock), buf);
          lv_label_set_text(id(lbl_timer4_clock), buf);
          lv_label_set_text(id(lbl_timer5_clock), buf);
          lv_label_set_text(id(lbl_timer6_clock), buf);
          lv_label_set_text(id(lbl_timer7_clock), buf);
          lv_label_set_text(id(lbl_timer8_clock), buf);

                    lv_label_set_text(id(lbl_plug8_text), "PLUG 8");

                    - lambda: |-
                      // Restore persisted timer settings and update UI colors/labels
                      bool e1 = id(plug1_schedule_persist);
                      id(plug1_schedule_enabled).publish_state(e1);
                      id(plug1_on_hour).publish_state((int)id(plug1_on_hour_persist));
                      id(plug1_on_minute).publish_state((int)id(plug1_on_minute_persist));
                      id(plug1_off_hour).publish_state((int)id(plug1_off_hour_persist));
                      id(plug1_off_minute).publish_state((int)id(plug1_off_minute_persist));
                      id(plug1_on_ampm).publish_state(id(plug1_on_ampm_persist));
                      id(plug1_off_ampm).publish_state(id(plug1_off_ampm_persist));
                      lv_label_set_text(id(lbl_schedule1_state), e1 ? "Schedule: ON" : "Schedule: OFF");
                      lv_obj_set_style_bg_color(id(btn_plug1_timer), e1 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

                      bool e2 = id(plug2_schedule_persist);
                      id(plug2_schedule_enabled).publish_state(e2);
                      id(plug2_on_hour).publish_state((int)id(plug2_on_hour_persist));
                      id(plug2_on_minute).publish_state((int)id(plug2_on_minute_persist));
                      id(plug2_off_hour).publish_state((int)id(plug2_off_hour_persist));
                      id(plug2_off_minute).publish_state((int)id(plug2_off_minute_persist));
                      id(plug2_on_ampm).publish_state(id(plug2_on_ampm_persist));
                      id(plug2_off_ampm).publish_state(id(plug2_off_ampm_persist));
                      lv_label_set_text(id(lbl_schedule2_state), e2 ? "Schedule: ON" : "Schedule: OFF");
                      lv_obj_set_style_bg_color(id(btn_plug2_timer), e2 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

                      bool e3 = id(plug3_schedule_persist);
                      id(plug3_schedule_enabled).publish_state(e3);
                      id(plug3_on_hour).publish_state((int)id(plug3_on_hour_persist));
                      id(plug3_on_minute).publish_state((int)id(plug3_on_minute_persist));
                      id(plug3_off_hour).publish_state((int)id(plug3_off_hour_persist));
                      id(plug3_off_minute).publish_state((int)id(plug3_off_minute_persist));
                      id(plug3_on_ampm).publish_state(id(plug3_on_ampm_persist));
                      id(plug3_off_ampm).publish_state(id(plug3_off_ampm_persist));
                      lv_label_set_text(id(lbl_schedule3_state), e3 ? "Schedule: ON" : "Schedule: OFF");
                      lv_obj_set_style_bg_color(id(btn_plug3_timer), e3 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

                      bool e4 = id(plug4_schedule_persist);
                      id(plug4_schedule_enabled).publish_state(e4);
                      id(plug4_on_hour).publish_state((int)id(plug4_on_hour_persist));
                      id(plug4_on_minute).publish_state((int)id(plug4_on_minute_persist));
                      id(plug4_off_hour).publish_state((int)id(plug4_off_hour_persist));
                      id(plug4_off_minute).publish_state((int)id(plug4_off_minute_persist));
                      id(plug4_on_ampm).publish_state(id(plug4_on_ampm_persist));
                      id(plug4_off_ampm).publish_state(id(plug4_off_ampm_persist));
                      lv_label_set_text(id(lbl_schedule4_state), e4 ? "Schedule: ON" : "Schedule: OFF");
                      lv_obj_set_style_bg_color(id(btn_plug4_timer), e4 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

                      bool e5 = id(plug5_schedule_persist);
                      id(plug5_schedule_enabled).publish_state(e5);
                      id(plug5_on_hour).publish_state((int)id(plug5_on_hour_persist));
                      id(plug5_on_minute).publish_state((int)id(plug5_on_minute_persist));
                      id(plug5_off_hour).publish_state((int)id(plug5_off_hour_persist));
                      id(plug5_off_minute).publish_state((int)id(plug5_off_minute_persist));
                      id(plug5_on_ampm).publish_state(id(plug5_on_ampm_persist));
                      id(plug5_off_ampm).publish_state(id(plug5_off_ampm_persist));
                      lv_label_set_text(id(lbl_schedule5_state), e5 ? "Schedule: ON" : "Schedule: OFF");
                      lv_obj_set_style_bg_color(id(btn_plug5_timer), e5 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

                      bool e6 = id(plug6_schedule_persist);
                      id(plug6_schedule_enabled).publish_state(e6);
                      id(plug6_on_hour).publish_state((int)id(plug6_on_hour_persist));
                      id(plug6_on_minute).publish_state((int)id(plug6_on_minute_persist));
                      id(plug6_off_hour).publish_state((int)id(plug6_off_hour_persist));
                      id(plug6_off_minute).publish_state((int)id(plug6_off_minute_persist));
                      id(plug6_on_ampm).publish_state(id(plug6_on_ampm_persist));
                      id(plug6_off_ampm).publish_state(id(plug6_off_ampm_persist));
                      lv_label_set_text(id(lbl_schedule6_state), e6 ? "Schedule: ON" : "Schedule: OFF");
                      lv_obj_set_style_bg_color(id(btn_plug6_timer), e6 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

                      bool e7 = id(plug7_schedule_persist);
                      id(plug7_schedule_enabled).publish_state(e7);
                      id(plug7_on_hour).publish_state((int)id(plug7_on_hour_persist));
                      id(plug7_on_minute).publish_state((int)id(plug7_on_minute_persist));
                      id(plug7_off_hour).publish_state((int)id(plug7_off_hour_persist));
                      id(plug7_off_minute).publish_state((int)id(plug7_off_minute_persist));
                      id(plug7_on_ampm).publish_state(id(plug7_on_ampm_persist));
                      id(plug7_off_ampm).publish_state(id(plug7_off_ampm_persist));
                      lv_label_set_text(id(lbl_schedule7_state), e7 ? "Schedule: ON" : "Schedule: OFF");
                      lv_obj_set_style_bg_color(id(btn_plug7_timer), e7 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

                      bool e8 = id(plug8_schedule_persist);
                      id(plug8_schedule_enabled).publish_state(e8);
                      id(plug8_on_hour).publish_state((int)id(plug8_on_hour_persist));
                      id(plug8_on_minute).publish_state((int)id(plug8_on_minute_persist));
                      id(plug8_off_hour).publish_state((int)id(plug8_off_hour_persist));
                      id(plug8_off_minute).publish_state((int)id(plug8_off_minute_persist));
                      id(plug8_on_ampm).publish_state(id(plug8_on_ampm_persist));
                      id(plug8_off_ampm).publish_state(id(plug8_off_ampm_persist));
                      lv_label_set_text(id(lbl_schedule8_state), e8 ? "Schedule: ON" : "Schedule: OFF");
                      lv_obj_set_style_bg_color(id(btn_plug8_timer), e8 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);
  pages:
    # MAIN PAGE
    - id: main_page
      widgets:
        # background only (no inner panel)
        - obj:
            id: main_bg
            x: 0
            y: 0
            width: 800
            height: 480
            bg_color: 0x101830

        - label:
            id: lbl_main_title
            align: top_mid
            y: 10
            text: "Boven Household Smart-Plug Control"
            text_font: font_small
            text_color: 0xFFFFFF

        # row 1
        - button:
            id: btn_plug1
            x: 20
            y: 70
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: "PLUG 1", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                              url: !lambda |-
                                return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug1_update_state

        - button:
            id: btn_plug1_timer
            x: 260
            y: 70
            width: 110
            height: 60
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl1_timer_main
                  text: "Timer OFF"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.label.update:
                    id: lbl1_timer_main
                    text: !lambda |-
                      return id(plug1_schedule_enabled).state
                        ? std::string("TIMER")
                        : std::string("TIMER");
                - lvgl.page.show: plug1_timer_page

        - button:
            id: btn_plug5
            x: 410
            y: 70
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: "PLUG 5", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                              url: !lambda |-
                                return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug5_update_state

        - button:
            id: btn_plug5_timer
            x: 650
            y: 70
            width: 110
            height: 60
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl5_timer_main
                  text: "Timer OFF"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.label.update:
                    id: lbl5_timer_main
                    text: !lambda |-
                      return id(plug5_schedule_enabled).state
                        ? std::string("TIMER")
                        : std::string("TIMER");
                - lvgl.page.show: plug5_timer_page

        # row 2
        - button:
            id: btn_plug2
            x: 20
            y: 150
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: "PLUG 2", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                              url: !lambda |-
                                return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug2_update_state

        - button:
            id: btn_plug2_timer
            x: 260
            y: 150
            width: 110
            height: 60
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl2_timer_main
                  text: "Timer OFF"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.label.update:
                    id: lbl2_timer_main
                    text: !lambda |-
                      return id(plug2_schedule_enabled).state
                        ? std::string("TIMER")
                        : std::string("TIMER");
                - lvgl.page.show: plug2_timer_page

        - button:
            id: btn_plug6
            x: 410
            y: 150
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: "PLUG 6", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                              url: !lambda |-
                                return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug6_update_state

        - button:
            id: btn_plug6_timer
            x: 650
            y: 150
            width: 110
            height: 60
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl6_timer_main
                  text: "Timer OFF"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.label.update:
                    id: lbl6_timer_main
                    text: !lambda |-
                      return id(plug6_schedule_enabled).state
                        ? std::string("TIMER")
                        : std::string("TIMER");
                - lvgl.page.show: plug6_timer_page

        # row 3
        - button:
            id: btn_plug3
            x: 20
            y: 230
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: "PLUG 3", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                              url: !lambda |-
                                return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug3_update_state

        - button:
            id: btn_plug3_timer
            x: 260
            y: 230
            width: 110
            height: 60
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl3_timer_main
                  text: "Timer OFF"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.label.update:
                    id: lbl3_timer_main
                    text: !lambda |-
                      return id(plug3_schedule_enabled).state
                        ? std::string("TIMER")
                        : std::string("TIMER");
                - lvgl.page.show: plug3_timer_page

        - button:
            id: btn_plug7
            x: 410
            y: 230
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: "PLUG 7", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                              url: !lambda |-
                                return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug7_update_state

        - button:
            id: btn_plug7_timer
            x: 650
            y: 230
            width: 110
            height: 60
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl7_timer_main
                  text: "Timer OFF"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.label.update:
                    id: lbl7_timer_main
                    text: !lambda |-
                      return id(plug7_schedule_enabled).state
                        ? std::string("TIMER")
                        : std::string("TIMER");
                - lvgl.page.show: plug7_timer_page

        # row 4
        - button:
            id: btn_plug4
            x: 20
            y: 310
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: "PLUG 4", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                              url: !lambda |-
                                return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug4_update_state

        - button:
            id: btn_plug4_timer
            x: 260
            y: 310
            width: 110
            height: 60
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl4_timer_main
                  text: "Timer OFF"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.label.update:
                    id: lbl4_timer_main
                    text: !lambda |-
                      return id(plug4_schedule_enabled).state
                        ? std::string("TIMER")
                        : std::string("TIMER");
                - lvgl.page.show: plug4_timer_page

        - button:
            id: btn_plug8
            x: 410
            y: 310
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets:
              - label:
                  id: lbl_plug8_text     # text label for Plug 8 button
                  text: "PLUG 8"         # initial, overridden in on_ready
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - script.execute: toggle_plug8_device

        - button:
            id: btn_plug8_timer
            x: 650
            y: 310
            width: 110
            height: 60
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl8_timer_main
                  text: "Timer OFF"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.label.update:
                    id: lbl8_timer_main
                    text: !lambda |-
                      return id(plug8_schedule_enabled).state
                        ? std::string("TIMER")
                        : std::string("TIMER");
                - lvgl.page.show: plug8_timer_page

        # backlight controls (shifted left so ON lines up with Timer 4)
        - label:
            x: 21
            y: 399
            text: "Backlight:"
            text_font: font_small
            text_color: 0xFFFFFF

        - button:
            id: btn_bl_auto
            x: 130     # was 140
            y: 386
            width: 120
            height: 50
            bg_color: 0x228B22
            widgets: [{ label: { text: "AUTO (5m)", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    id(bl_mode) = 0;
                    lv_obj_set_style_bg_color(id(btn_bl_auto), lv_color_hex(0x228B22), LV_PART_MAIN);
                    lv_obj_set_style_bg_color(id(btn_bl_on),   lv_color_hex(0x444444), LV_PART_MAIN);

        - button:
            id: btn_bl_on
            x: 260     # was 270, now aligned under Plug 4 Timer
            y: 386
            width: 110
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "ON", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    id(bl_mode) = 1;
                    id(lcd_backlight_sw).turn_on();
                    auto call = id(lcdbacklight).turn_on();
                    float bri = id(bl_level) / 100.0f;
                    call.set_brightness(bri);
                    call.perform();
                    lv_obj_set_style_bg_color(id(btn_bl_on),   lv_color_hex(0x228B22), LV_PART_MAIN);
                    lv_obj_set_style_bg_color(id(btn_bl_auto), lv_color_hex(0x444444), LV_PART_MAIN);
                - script.execute: register_activity

        # IP Settings button
        - button:
            id: btn_ip_settings
            x: 410
            y: 386
            width: 110
            height: 50
            bg_color: 0xFF8800
            widgets: [{ label: { text: "IP Setup", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    auto fix = [](std::string s)->std::string {
                      if (s.size() >= 2 && s.front() == '"' && s.back() == '"') return s.substr(1, s.size()-2);
                      return s;
                    };
                    std::string s1 = fix(id(plug1_ip_str));
                    std::string s2 = fix(id(plug2_ip_str));
                    std::string s3 = fix(id(plug3_ip_str));
                    std::string s4 = fix(id(plug4_ip_str));
                    std::string s5 = fix(id(plug5_ip_str));
                    std::string s6 = fix(id(plug6_ip_str));
                    std::string s7 = fix(id(plug7_ip_str));
                    std::string s8 = fix(id(plug8_ip_str));
                    lv_textarea_set_text(id(ip1_text), s1.c_str());
                    lv_textarea_set_text(id(ip2_text), s2.c_str());
                    lv_textarea_set_text(id(ip3_text), s3.c_str());
                    lv_textarea_set_text(id(ip4_text), s4.c_str());
                    lv_textarea_set_text(id(ip5_text), s5.c_str());
                    lv_textarea_set_text(id(ip6_text), s6.c_str());
                    lv_textarea_set_text(id(ip7_text), s7.c_str());
                    lv_textarea_set_text(id(ip8_text), s8.c_str());
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip1_text
                - lvgl.page.show: ip_setup_page

        - button:
            id: btn_plug_info
            x: 530
            y: 386
            width: 110
            height: 50
            bg_color: 0x4444FF
            widgets: [{ label: { text: "Plug Info", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - script.execute: fetch_all_plug_info
                - lvgl.page.show: plug_info_page

        # main page clock (bottom right)
        # CLOCK POSITION ADJUSTMENT (moved down 5px)
        - label:
            id: lbl_main_time
            x: 655
            y: 393
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

    # PLUG 1 TIMER PAGE
    - id: plug1_timer_page
      widgets:
        - label:
            id: lbl_timer1_title
            x: 20
            y: 10
            text: "PLUG 1 TIMER"
            text_font: font_large
            text_color: 0xFFFFFF

        # clock on timer page
        - label:
            id: lbl_timer1_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer1_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule1_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule1_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Schedule: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug1_schedule_enabled).state;
                    bool next = !cur;
                    id(plug1_schedule_enabled).publish_state(next);
                    id(plug1_schedule_persist) = next;
                    auto lbl = id(lbl_schedule1_state);
                    lv_label_set_text(lbl, next ? "Schedule: ON" : "Schedule: OFF");
                    auto col = next ? lv_color_hex(0x228B22) : lv_color_hex(0x444444);
                    lv_obj_set_style_bg_color(id(btn_plug1_timer), col, LV_PART_MAIN);

        - label:
            id: lbl1_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn1_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug1_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug1_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn1_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug1_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug1_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn1_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug1_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug1_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn1_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug1_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug1_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn1_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl1_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug1_on_ampm).state;
                    id(plug1_on_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl1_on_ampm
                    text: !lambda |-
                      return id(plug1_on_ampm).state;
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - label:
            id: lbl1_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn1_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug1_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug1_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn1_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug1_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug1_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn1_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug1_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug1_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn1_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug1_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug1_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn1_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl1_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug1_off_ampm).state;
                    id(plug1_off_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl1_off_ampm
                    text: !lambda |-
                      return id(plug1_off_ampm).state;
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

    # PLUG 2 TIMER PAGE
    - id: plug2_timer_page
      widgets:
        - label:
            id: lbl_timer2_title
            x: 20
            y: 10
            text: "PLUG 2 TIMER"
            text_font: font_large
            text_color: 0xFFFFFF

        # clock on timer page
        - label:
            id: lbl_timer2_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer2_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule2_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule2_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Schedule: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug2_schedule_enabled).state;
                    bool next = !cur;
                    id(plug2_schedule_enabled).publish_state(next);
                    id(plug2_schedule_persist) = next;
                    auto lbl = id(lbl_schedule2_state);
                    lv_label_set_text(lbl, next ? "Schedule: ON" : "Schedule: OFF");
                    auto col = next ? lv_color_hex(0x228B22) : lv_color_hex(0x444444);
                    lv_obj_set_style_bg_color(id(btn_plug2_timer), col, LV_PART_MAIN);

        - label:
            id: lbl2_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn2_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug2_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug2_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn2_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug2_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug2_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn2_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug2_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug2_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn2_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug2_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug2_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn2_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl2_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug2_on_ampm).state;
                    id(plug2_on_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl2_on_ampm
                    text: !lambda |-
                      return id(plug2_on_ampm).state;
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - label:
            id: lbl2_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn2_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug2_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug2_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn2_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug2_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug2_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn2_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug2_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug2_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn2_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug2_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug2_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn2_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl2_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug2_off_ampm).state;
                    id(plug2_off_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl2_off_ampm
                    text: !lambda |-
                      return id(plug2_off_ampm).state;
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

    # PLUG 3 TIMER PAGE (NEW  same style as 1 & 2)
    - id: plug3_timer_page
      widgets:
        - label:
            id: lbl_timer3_title
            x: 20
            y: 10
            text: "PLUG 3 TIMER"
            text_font: font_large
            text_color: 0xFFFFFF

        # clock on timer page
        - label:
            id: lbl_timer3_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer3_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule3_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule3_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Schedule: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug3_schedule_enabled).state;
                    bool next = !cur;
                    id(plug3_schedule_enabled).publish_state(next);
                    id(plug3_schedule_persist) = next;
                    auto lbl = id(lbl_schedule3_state);
                    lv_label_set_text(lbl, next ? "Schedule: ON" : "Schedule: OFF");
                    auto col = next ? lv_color_hex(0x228B22) : lv_color_hex(0x444444);
                    lv_obj_set_style_bg_color(id(btn_plug3_timer), col, LV_PART_MAIN);

        - label:
            id: lbl3_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn3_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug3_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug3_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn3_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug3_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug3_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn3_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug3_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug3_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn3_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug3_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug3_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn3_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl3_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug3_on_ampm).state;
                    id(plug3_on_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl3_on_ampm
                    text: !lambda |-
                      return id(plug3_on_ampm).state;
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - label:
            id: lbl3_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn3_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug3_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug3_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn3_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug3_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug3_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn3_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug3_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug3_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn3_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug3_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug3_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn3_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl3_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug3_off_ampm).state;
                    id(plug3_off_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl3_off_ampm
                    text: !lambda |-
                      return id(plug3_off_ampm).state;
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

    # PLUG 4 TIMER PAGE
    - id: plug4_timer_page
      widgets:
        - label:
            id: lbl_timer4_title
            x: 20
            y: 10
            text: "PLUG 4 TIMER"
            text_font: font_large
            text_color: 0xFFFFFF

        # clock on timer page
        - label:
            id: lbl_timer4_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer4_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule4_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule4_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Schedule: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug4_schedule_enabled).state;
                    bool next = !cur;
                    id(plug4_schedule_enabled).publish_state(next);
                    id(plug4_schedule_persist) = next;
                    auto lbl = id(lbl_schedule4_state);
                    lv_label_set_text(lbl, next ? "Schedule: ON" : "Schedule: OFF");
                    auto col = next ? lv_color_hex(0x228B22) : lv_color_hex(0x444444);
                    lv_obj_set_style_bg_color(id(btn_plug4_timer), col, LV_PART_MAIN);

        - label:
            id: lbl4_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn4_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug4_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug4_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn4_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug4_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug4_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn4_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug4_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug4_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn4_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug4_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug4_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn4_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl4_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug4_on_ampm).state;
                    id(plug4_on_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl4_on_ampm
                    text: !lambda |-
                      return id(plug4_on_ampm).state;
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - label:
            id: lbl4_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn4_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug4_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug4_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn4_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug4_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug4_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn4_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug4_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug4_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn4_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug4_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug4_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn4_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl4_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug4_off_ampm).state;
                    id(plug4_off_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl4_off_ampm
                    text: !lambda |-
                      return id(plug4_off_ampm).state;
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

    # PLUG 5 TIMER PAGE
    - id: plug5_timer_page
      widgets:
        - label:
            id: lbl_timer5_title
            x: 20
            y: 10
            text: "PLUG 5 TIMER"
            text_font: font_large
            text_color: 0xFFFFFF

        # clock on timer page
        - label:
            id: lbl_timer5_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer5_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule5_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule5_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Schedule: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug5_schedule_enabled).state;
                    bool next = !cur;
                    id(plug5_schedule_enabled).publish_state(next);
                    id(plug5_schedule_persist) = next;
                    auto lbl = id(lbl_schedule5_state);
                    lv_label_set_text(lbl, next ? "Schedule: ON" : "Schedule: OFF");
                    auto col = next ? lv_color_hex(0x228B22) : lv_color_hex(0x444444);
                    lv_obj_set_style_bg_color(id(btn_plug5_timer), col, LV_PART_MAIN);

        - label:
            id: lbl5_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn5_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug5_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug5_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn5_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug5_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug5_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn5_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug5_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug5_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn5_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug5_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug5_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn5_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl5_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug5_on_ampm).state;
                    id(plug5_on_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl5_on_ampm
                    text: !lambda |-
                      return id(plug5_on_ampm).state;
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - label:
            id: lbl5_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn5_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug5_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug5_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn5_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug5_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug5_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn5_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug5_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug5_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn5_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug5_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug5_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn5_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl5_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug5_off_ampm).state;
                    id(plug5_off_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl5_off_ampm
                    text: !lambda |-
                      return id(plug5_off_ampm).state;
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

    # PLUG 6 TIMER PAGE
    - id: plug6_timer_page
      widgets:
        - label:
            id: lbl_timer6_title
            x: 20
            y: 10
            text: "PLUG 6 TIMER"
            text_font: font_large
            text_color: 0xFFFFFF

        # clock on timer page
        - label:
            id: lbl_timer6_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer6_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule6_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule6_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Schedule: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug6_schedule_enabled).state;
                    bool next = !cur;
                    id(plug6_schedule_enabled).publish_state(next);
                    id(plug6_schedule_persist) = next;
                    auto lbl = id(lbl_schedule6_state);
                    lv_label_set_text(lbl, next ? "Schedule: ON" : "Schedule: OFF");
                    auto col = next ? lv_color_hex(0x228B22) : lv_color_hex(0x444444);
                    lv_obj_set_style_bg_color(id(btn_plug6_timer), col, LV_PART_MAIN);

        - label:
            id: lbl6_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn6_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug6_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug6_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn6_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug6_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug6_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn6_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug6_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug6_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn6_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug6_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug6_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn6_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl6_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug6_on_ampm).state;
                    id(plug6_on_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl6_on_ampm
                    text: !lambda |-
                      return id(plug6_on_ampm).state;
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - label:
            id: lbl6_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn6_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug6_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug6_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn6_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug6_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug6_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn6_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug6_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug6_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn6_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug6_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug6_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn6_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl6_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug6_off_ampm).state;
                    id(plug6_off_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl6_off_ampm
                    text: !lambda |-
                      return id(plug6_off_ampm).state;
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

    # PLUG 7 TIMER PAGE
    - id: plug7_timer_page
      widgets:
        - label:
            id: lbl_timer7_title
            x: 20
            y: 10
            text: "PLUG 7 TIMER"
            text_font: font_large
            text_color: 0xFFFFFF

        # clock on timer page
        - label:
            id: lbl_timer7_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer7_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule7_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule7_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Schedule: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug7_schedule_enabled).state;
                    bool next = !cur;
                    id(plug7_schedule_enabled).publish_state(next);
                    id(plug7_schedule_persist) = next;
                    auto lbl = id(lbl_schedule7_state);
                    lv_label_set_text(lbl, next ? "Schedule: ON" : "Schedule: OFF");
                    auto col = next ? lv_color_hex(0x228B22) : lv_color_hex(0x444444);
                    lv_obj_set_style_bg_color(id(btn_plug7_timer), col, LV_PART_MAIN);

        - label:
            id: lbl7_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn7_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug7_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug7_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn7_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug7_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug7_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn7_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug7_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug7_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn7_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug7_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug7_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn7_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl7_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug7_on_ampm).state;
                    id(plug7_on_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl7_on_ampm
                    text: !lambda |-
                      return id(plug7_on_ampm).state;
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - label:
            id: lbl7_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn7_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug7_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug7_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn7_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug7_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug7_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn7_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug7_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug7_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn7_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug7_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug7_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn7_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl7_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug7_off_ampm).state;
                    id(plug7_off_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl7_off_ampm
                    text: !lambda |-
                      return id(plug7_off_ampm).state;
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

    # PLUG 8 TIMER PAGE
    - id: plug8_timer_page
      widgets:
        - label:
            id: lbl_timer8_title
            x: 20
            y: 10
            text: "PLUG 8 TIMER"
            text_font: font_large
            text_color: 0xFFFFFF

        # clock on timer page
        - label:
            id: lbl_timer8_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer8_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule8_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule8_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Schedule: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug8_schedule_enabled).state;
                    bool next = !cur;
                    id(plug8_schedule_enabled).publish_state(next);
                    id(plug8_schedule_persist) = next;
                    auto lbl = id(lbl_schedule8_state);
                    lv_label_set_text(lbl, next ? "Schedule: ON" : "Schedule: OFF");
                    auto col = next ? lv_color_hex(0x228B22) : lv_color_hex(0x444444);
                    lv_obj_set_style_bg_color(id(btn_plug8_timer), col, LV_PART_MAIN);

        - label:
            id: lbl8_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn8_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug8_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug8_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn8_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug8_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug8_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn8_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug8_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug8_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn8_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug8_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug8_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn8_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl8_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug8_on_ampm).state;
                    id(plug8_on_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl8_on_ampm
                    text: !lambda |-
                      return id(plug8_on_ampm).state;
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - label:
            id: lbl8_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn8_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug8_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug8_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn8_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug8_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug8_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn8_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug8_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug8_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn8_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug8_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug8_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

        - button:
            id: btn8_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl8_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug8_off_ampm).state;
                    id(plug8_off_ampm).publish_state(cur == "AM" ? "PM" : "AM");
                - lvgl.label.update:
                    id: lbl8_off_ampm
                    text: !lambda |-
                      return id(plug8_off_ampm).state;
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);

    # IP ADDRESS SETUP PAGE
    - id: ip_setup_page
      widgets:
        # Background
        - obj:
            id: ip_bg
            x: 0
            y: 0
            width: 800
            height: 480
            bg_color: 0x101830

        # Title
        - label:
            id: lbl_ip_title
            align: top_mid
            y: 10
            text: "IP Address Setup"
            text_font: font_large
            text_color: 0xFFFFFF

        # Plug 1 IP
        - label:
            text: "Plug 1:"
            x: 20
            y: 60
            text_color: 0xFFFFFF
            text_font: font_small

        - textarea:
            id: ip1_text
            x: 120
            y: 55
            width: 200
            height: 35
            one_line: true
            placeholder_text: "192.168.68.79"
            on_value:
              then:
                - lambda: |-
                    id(plug1_ip_str) = text;
                    ESP_LOGI("ip_setup", "Plug 1 IP set to: %s", id(plug1_ip_str).c_str());
            on_click:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip1_text
            on_focus:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip1_text
                

        # Plug 2 IP
        - label:
            text: "Plug 2:"
            x: 20
            y: 100
            text_color: 0xFFFFFF
            text_font: font_small

        - textarea:
            id: ip2_text
            x: 120
            y: 95
            width: 200
            height: 35
            one_line: true
            placeholder_text: "192.168.68.77"
            on_value:
              then:
                - lambda: |-
                    id(plug2_ip_str) = text;
                    ESP_LOGI("ip_setup", "Plug 2 IP set to: %s", id(plug2_ip_str).c_str());
            on_click:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip2_text
            on_focus:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip2_text
                

        # Plug 3 IP
        - label:
            text: "Plug 3:"
            x: 20
            y: 140
            text_color: 0xFFFFFF
            text_font: font_small

        - textarea:
            id: ip3_text
            x: 120
            y: 135
            width: 200
            height: 35
            one_line: true
            placeholder_text: "192.168.68.76"
            on_value:
              then:
                - lambda: |-
                    id(plug3_ip_str) = text;
                    ESP_LOGI("ip_setup", "Plug 3 IP set to: %s", id(plug3_ip_str).c_str());
            on_click:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip3_text
            on_focus:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip3_text
                

        # Plug 4 IP
        - label:
            text: "Plug 4:"
            x: 20
            y: 180
            text_color: 0xFFFFFF
            text_font: font_small

        - textarea:
            id: ip4_text
            x: 120
            y: 175
            width: 200
            height: 35
            one_line: true
            placeholder_text: "192.168.68.75"
            on_value:
              then:
                - lambda: |-
                    id(plug4_ip_str) = text;
                    ESP_LOGI("ip_setup", "Plug 4 IP set to: %s", id(plug4_ip_str).c_str());
            on_click:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip4_text
            on_focus:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip4_text
                

        # Plug 5 IP
        - label:
            text: "Plug 5:"
            x: 420
            y: 60
            text_color: 0xFFFFFF
            text_font: font_small

        - textarea:
            id: ip5_text
            x: 520
            y: 55
            width: 200
            height: 35
            one_line: true
            placeholder_text: "192.168.68.203"
            on_value:
              then:
                - lambda: |-
                    id(plug5_ip_str) = text;
                    ESP_LOGI("ip_setup", "Plug 5 IP set to: %s", id(plug5_ip_str).c_str());
            on_click:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip5_text
            on_focus:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip5_text
                

        # Plug 6 IP
        - label:
            text: "Plug 6:"
            x: 420
            y: 100
            text_color: 0xFFFFFF
            text_font: font_small

        - textarea:
            id: ip6_text
            x: 520
            y: 95
            width: 200
            height: 35
            one_line: true
            placeholder_text: "192.168.68.204"
            on_value:
              then:
                - lambda: |-
                    id(plug6_ip_str) = text;
                    ESP_LOGI("ip_setup", "Plug 6 IP set to: %s", id(plug6_ip_str).c_str());
            on_click:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip6_text
            on_focus:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip6_text
                

        # Plug 7 IP
        - label:
            text: "Plug 7:"
            x: 420
            y: 140
            text_color: 0xFFFFFF
            text_font: font_small

        - textarea:
            id: ip7_text
            x: 520
            y: 135
            width: 200
            height: 35
            one_line: true
            placeholder_text: "192.168.68.205"
            on_value:
              then:
                - lambda: |-
                    id(plug7_ip_str) = text;
                    ESP_LOGI("ip_setup", "Plug 7 IP set to: %s", id(plug7_ip_str).c_str());
            on_click:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip7_text
            on_focus:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip7_text
                

        # Plug 8 IP
        - label:
            text: "Plug 8:"
            x: 420
            y: 180
            text_color: 0xFFFFFF
            text_font: font_small

        - textarea:
            id: ip8_text
            x: 520
            y: 175
            width: 200
            height: 35
            one_line: true
            placeholder_text: "192.168.68.206"
            on_value:
              then:
                - lambda: |-
                    id(plug8_ip_str) = text;
                    ESP_LOGI("ip_setup", "Plug 8 IP set to: %s", id(plug8_ip_str).c_str());
            on_click:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip8_text
            on_focus:
              then:
                - lvgl.keyboard.update:
                    id: keyboard_ip
                    mode: LV_KEYBOARD_MODE_TEXT_LOWER
                    textarea: ip8_text
            

        # On-screen Keyboard
        - keyboard:
            id: keyboard_ip
            y: 230
            width: 800
            height: 200
            mode: LV_KEYBOARD_MODE_TEXT_LOWER
            textarea: ip1_text

        # Save Button
        - button:
            id: btn_ip_save
            x: 250
            y: 420
            width: 150
            height: 45
            bg_color: 0x228B22
            widgets:
              - label:
                  text: "Save IPs"
                  align: center
                  text_font: font_small
            on_click:
              then:
              - logger.log:
                  format: "IP addresses saved"
                  level: INFO
                  tag: ip_setup
              - lvgl.page.show: main_page

        # Back Button
        - button:
            id: btn_ip_back
            x: 420
            y: 420
            width: 150
            height: 45
            bg_color: 0x444444
            widgets:
              - label:
                  text: "Back"
                  align: center
                  text_font: font_small
            on_click:
              then:
                - lvgl.page.show: main_page

    # PLUG INFO PAGE
    - id: plug_info_page
      widgets:
      - obj:
          id: info_bg
          x: 0
          y: 0
          width: 800
          height: 480
          bg_color: 0x101830

      - label:
          text: "Plug Information"
          align: top_mid
          y: 10
          text_font: font_large
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug1_title
          text: "Plug 1:"
          x: 20
          y: 60
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug1_info
          text: "-"
          x: 120
          y: 60
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - label:
          id: lbl_plug2_title
          text: "Plug 2:"
          x: 20
          y: 90
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug2_info
          text: "-"
          x: 120
          y: 90
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - label:
          id: lbl_plug3_title
          text: "Plug 3:"
          x: 20
          y: 120
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug3_info
          text: "-"
          x: 120
          y: 120
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - label:
          id: lbl_plug4_title
          text: "Plug 4:"
          x: 20
          y: 150
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug4_info
          text: "-"
          x: 120
          y: 150
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - label:
          id: lbl_plug5_title
          text: "Plug 5:"
          x: 20
          y: 190
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug5_info
          text: "-"
          x: 120
          y: 190
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - label:
          id: lbl_plug6_title
          text: "Plug 6:"
          x: 20
          y: 220
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug6_info
          text: "-"
          x: 120
          y: 220
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - label:
          id: lbl_plug7_title
          text: "Plug 7:"
          x: 20
          y: 250
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug7_info
          text: "-"
          x: 120
          y: 250
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - label:
          id: lbl_plug8_title
          text: "Plug 8:"
          x: 20
          y: 280
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug8_info
          text: "-"
          x: 120
          y: 280
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - button:
          id: btn_info_refresh
          x: 200
          y: 340
          width: 150
          height: 45
          bg_color: 0x228B22
          widgets: [{ label: { text: "Refresh", align: center, text_font: font_small }}]
          on_click:
            then:
            - script.execute: fetch_all_plug_info

      - button:
          id: btn_info_back
          x: 380
          y: 340
          width: 150
          height: 45
          bg_color: 0x444444
          widgets: [{ label: { text: "Back", align: center, text_font: font_small }}]
          on_click:
            then:
            - lvgl.page.show: main_page

interval:
  # Backlight auto-off check stays light
  - interval: 10s
    then:
      - script.execute: bl_auto_off_check
      - script.execute: fetch_all_plug_info

  # Occasional keep-alive check for plug 1 (optional)
  - interval: 2min
    then:
      - if:
          condition:
            wifi.connected:
          then:
            - script.execute: plug1_update_state

  # Periodic quick state check for all plugs (reflect unplugged devices quickly)
  - interval: 15s
    then:
      - if:
          condition:
            wifi.connected:
          then:
            - script.execute: plug1_update_state
            - script.execute: plug2_update_state
            - script.execute: plug3_update_state
            - script.execute: plug4_update_state
            - script.execute: plug5_update_state
            - script.execute: plug6_update_state
            - script.execute: plug7_update_state
            - script.execute: plug8_update_state

  # clock update every 10s
  - interval: 10s
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          char buf[16];
          int h12 = now.hour % 12;
          if (h12 == 0) h12 = 12;
          bool pm = now.hour >= 12;
          sprintf(buf, "%02d:%02d %s", h12, now.minute, pm ? "PM" : "AM");
          lv_label_set_text(id(lbl_main_time), buf);
          lv_label_set_text(id(lbl_timer1_clock), buf);
          lv_label_set_text(id(lbl_timer2_clock), buf);
          lv_label_set_text(id(lbl_timer3_clock), buf);
          lv_label_set_text(id(lbl_timer4_clock), buf);
          lv_label_set_text(id(lbl_timer5_clock), buf);
          lv_label_set_text(id(lbl_timer6_clock), buf);
          lv_label_set_text(id(lbl_timer7_clock), buf);
          lv_label_set_text(id(lbl_timer8_clock), buf);

  # Plug 1 schedule
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug1_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug1_on_hour).state;
          int on_m   = (int) id(plug1_on_minute).state;
          auto on_ampm = id(plug1_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug1_off_hour).state;
          int off_m   = (int) id(plug1_off_minute).state;
          auto off_ampm = id(plug1_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          static bool last_on1 = false;
          if (should_on != last_on1) {
            last_on1 = should_on;
            if (should_on) id(plug1_turn_on).execute();
            else           id(plug1_turn_off).execute();
          }

  # Plug 2 schedule
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug2_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug2_on_hour).state;
          int on_m   = (int) id(plug2_on_minute).state;
          auto on_ampm = id(plug2_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug2_off_hour).state;
          int off_m   = (int) id(plug2_off_minute).state;
          auto off_ampm = id(plug2_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          static bool last_on2 = false;
          if (should_on != last_on2) {
            last_on2 = should_on;
            if (should_on) id(plug2_turn_on).execute();
            else           id(plug2_turn_off).execute();
          }

  # Plug 38 schedules
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;

          // plug 3
          if (id(plug3_schedule_enabled).state) {
            int cur = now.hour * 60 + now.minute;
            int on_h12 = (int) id(plug3_on_hour).state;
            int on_m   = (int) id(plug3_on_minute).state;
            auto on_ampm = id(plug3_on_ampm).state;
            bool on_pm = (on_ampm == "PM");
            int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
            int on_min = on_h24 * 60 + on_m;

            int off_h12 = (int) id(plug3_off_hour).state;
            int off_m   = (int) id(plug3_off_minute).state;
            auto off_ampm = id(plug3_off_ampm).state;
            bool off_pm = (off_ampm == "PM");
            int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
            int off_min = off_h24 * 60 + off_m;

            bool should = (cur >= on_min) && (cur < off_min);
            static bool last3 = false;
            if (should != last3) {
              last3 = should;
              if (should) id(plug3_turn_on).execute();
              else        id(plug3_turn_off).execute();
            }
          }

  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;

          // ---------- PLUG 4 SCHEDULER ----------
          // CHANGE IDs BELOW IF YOU MAKE NEW PLUGS (plug5, plug6, etc.)
          if (id(plug4_schedule_enabled).state) {              // <--- schedule enable toggle
            int cur = now.hour * 60 + now.minute;              // current time in minutes

            // ---------- ON time ----------
            int on_h12 = (int) id(plug4_on_hour).state;        // <--- selected ON hour
            int on_m   = (int) id(plug4_on_minute).state;      // <--- selected ON minute
            auto on_ampm = id(plug4_on_ampm).state;            // <--- "AM"/"PM" selector
            bool on_pm = (on_ampm == "PM");
            int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);     // convert to 24-hour time
            int on_min = on_h24 * 60 + on_m;                   // total ON time in minutes

            // ---------- OFF time ----------
            int off_h12 = (int) id(plug4_off_hour).state;      // <--- selected OFF hour
            int off_m   = (int) id(plug4_off_minute).state;    // <--- selected OFF minute
            auto off_ampm = id(plug4_off_ampm).state;          // <--- "AM"/"PM" selector
            bool off_pm = (off_ampm == "PM");
            int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);  // convert to 24-hour time
            int off_min = off_h24 * 60 + off_m;                // total OFF time in minutes

            // ---------- Compare and act ----------
            bool should = (cur >= on_min) && (cur < off_min);  // true = should be ON
            static bool last4 = false;                         // <--- remember last state
            if (should != last4) {
              last4 = should;
              if (should) {
                id(plug4_turn_on).execute();                   // <--- call ON script
              } else {
                id(plug4_turn_off).execute();                  // <--- call OFF script
              }
            }
          }

          // plug 5
          if (id(plug5_schedule_enabled).state) {
            int cur = now.hour * 60 + now.minute;
            int on_h12 = (int) id(plug5_on_hour).state;
            int on_m   = (int) id(plug5_on_minute).state;
            auto on_ampm = id(plug5_on_ampm).state;
            bool on_pm = (on_ampm == "PM");
            int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
            int on_min = on_h24 * 60 + on_m;

            int off_h12 = (int) id(plug5_off_hour).state;
            int off_m   = (int) id(plug5_off_minute).state;
            auto off_ampm = id(plug5_off_ampm).state;
            bool off_pm = (off_ampm == "PM");
            int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
            int off_min = off_h24 * 60 + off_m;

            bool should = (cur >= on_min) && (cur < off_min);
            static bool last5 = false;
            if (should != last5) {
              last5 = should;
              if (should) id(plug5_turn_on).execute();
              else        id(plug5_turn_off).execute();
            }
          }

          // plug 6
          if (id(plug6_schedule_enabled).state) {
            int cur = now.hour * 60 + now.minute;
            int on_h12 = (int) id(plug6_on_hour).state;
            int on_m   = (int) id(plug6_on_minute).state;
            auto on_ampm = id(plug6_on_ampm).state;
            bool on_pm = (on_ampm == "PM");
            int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
            int on_min = on_h24 * 60 + on_m;

            int off_h12 = (int) id(plug6_off_hour).state;
            int off_m   = (int) id(plug6_off_minute).state;
            auto off_ampm = id(plug6_off_ampm).state;
            bool off_pm = (off_ampm == "PM");
            int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
            int off_min = off_h24 * 60 + off_m;

            bool should = (cur >= on_min) && (cur < off_min);
            static bool last6 = false;
            if (should != last6) {
              last6 = should;
              if (should) id(plug6_turn_on).execute();
              else        id(plug6_turn_off).execute();
            }
          }

          // plug 7
          if (id(plug7_schedule_enabled).state) {
            int cur = now.hour * 60 + now.minute;
            int on_h12 = (int) id(plug7_on_hour).state;
            int on_m   = (int) id(plug7_on_minute).state;
            auto on_ampm = id(plug7_on_ampm).state;
            bool on_pm = (on_ampm == "PM");
            int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
            int on_min = on_h24 * 60 + on_m;

            int off_h12 = (int) id(plug7_off_hour).state;
            int off_m   = (int) id(plug7_off_minute).state;
            auto off_ampm = id(plug7_off_ampm).state;
            bool off_pm = (off_ampm == "PM");
            int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
            int off_min = off_h24 * 60 + off_m;

            bool should = (cur >= on_min) && (cur < off_min);
            static bool last7 = false;
            if (should != last7) {
              last7 = should;
              if (should) id(plug7_turn_on).execute();
              else        id(plug7_turn_off).execute();
            }
          }

          // plug 8
          if (id(plug8_schedule_enabled).state) {
            int cur = now.hour * 60 + now.minute;
            int on_h12 = (int) id(plug8_on_hour).state;
            int on_m   = (int) id(plug8_on_minute).state;
            auto on_ampm = id(plug8_on_ampm).state;
            bool on_pm = (on_ampm == "PM");
            int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
            int on_min = on_h24 * 60 + on_m;

            int off_h12 = (int) id(plug8_off_hour).state;
            int off_m   = (int) id(plug8_off_minute).state;
            auto off_ampm = id(plug8_off_ampm).state;
            bool off_pm = (off_ampm == "PM");
            int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
            int off_min = off_h24 * 60 + off_m;

            bool should = (cur >= on_min) && (cur < off_min);
            static bool last8 = false;
            if (should != last8) {
              last8 = should;
              if (should) id(plug8_turn_on).execute();
              else        id(plug8_turn_off).execute();
            }
          }